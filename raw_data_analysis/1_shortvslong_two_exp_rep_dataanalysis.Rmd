---
title: "RT-qPCR of tRPS3-tSRO9 short vs. long (2 reps)"
author: "Jamie Auxillos"
date: "31/08/2020 (Data analysis on Sept 7, 2020)"
output:
  html_document:
    toc: yes
    #toc_depth: 2
---

```{r setup,warning=FALSE,message=FALSE,echo=FALSE}

## knitr options for report generation
knitr::opts_chunk$set(warning=FALSE,message=FALSE,echo=TRUE,cache=FALSE,
                      #results="show",
                      fig.path="figures_shortvslong_dataanalysis/")

library(tidyverse)
library(cowplot)
library(tidyqpcr)

 # set default theme for graphics
theme_set(theme_cowplot(font_size=11) %+replace% 
              theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
                    panel.border=element_rect(colour = "grey50",linetype = "solid",size=0.5),
                    panel.grid.major = element_line(size = 0.25, linetype = 'solid',colour = "grey"),
                    plot.title = element_text(family="Tahoma",size=11,vjust=3.3),
                    strip.background = element_blank(),
                    strip.text.x=element_text(family="Tahoma",size=9),
                    axis.text=element_text(family="Tahoma", size=10),
                    axis.title=element_text(family="Tahoma", size=10),
                    legend.text=element_text(family="Tahoma", size=8),
                    legend.title=element_text(family="Tahoma", size=9)))
```

```{r label_plates,dependson="plate_functions", echo=FALSE}

# list Targets (Primer sets)
TargetID <- c("mCh-7", "URA3-ORF", "RPS3-ORF", "PGK1-ORF", "SRO9-ORF")
TargetIDvalues <-factor(rep(TargetID,levels=TargetID))

# Rowkeys incorporating TargetID information into rowkeys
rowkey1 <- tibble(WellR=LETTERS[1:5], TargetID=TargetIDvalues) 
rowkey2 <- tibble(WellR=LETTERS[6:10], TargetID=TargetIDvalues) 
rowkey3 <- tibble(WellR=LETTERS[11:15], TargetID=TargetIDvalues) 

# labelling of Strain attributes
Strainlevels_1 <- c("pRPS3-mCherry-tRPS3_WT-59bp","pRPS3-mCherry-tRPS3_WT-86bp")
Strainvalues_1 <- factor(rep(Strainlevels_1,each=3),levels=Strainlevels_1)
Strainlevels_2 <- c("pRPS3-mCherry-tRPS3_WT-200bp","POT1-ccdB")
Strainvalues_2 <- factor(rep(Strainlevels_2,each=3),levels=Strainlevels_2)
Strainlevels_3 <- c("pSRO9-mCherry-tSRO9_WT-200bp", "pSRO9-mCherry-tSRO9_WT-500bp")
Strainvalues_3 <- factor(rep(Strainlevels_3,each=3),levels=Strainlevels_3)

# labelling of BioRep attributes
BioReplevels_A <- c("BioRep1","BioRep2","BioRep3")
BioRepvalues_A <- factor(rep(BioReplevels_A,times=2),levels=BioReplevels_A)
BioReplevels_B <- c("BioRep4","BioRep5","BioRep6")
BioRepvalues_B <- factor(rep(BioReplevels_B,times=2),levels=BioReplevels_B)

# Colkeys incorporating Strain and BioRep information into colkeys for plate 1 (BioRep 1, 2 and 3)
colkey1 <- create_colkey_6in24(Strain=Strainvalues_1, BioRep=BioRepvalues_A)
colkey2 <- create_colkey_6in24(Strain=Strainvalues_2, BioRep=BioRepvalues_A)
colkey3 <- create_colkey_6in24(Strain=Strainvalues_3, BioRep=BioRepvalues_A)

# Colkeys incorporating Strain and BioRep information into colkeys for plate 2 (BioRep 4, 5 and 6)
colkey4 <- create_colkey_6in24(Strain=Strainvalues_1, BioRep=BioRepvalues_B)
colkey5 <- create_colkey_6in24(Strain=Strainvalues_2, BioRep=BioRepvalues_B)
colkey6 <- create_colkey_6in24(Strain=Strainvalues_3, BioRep=BioRepvalues_B)

# Plate plans for plate A (BioRep 1, 2 and 3)
plateplan1 <-label_plate_rowcol(create_blank_plate(WellR = LETTERS[1:5],WellC=1:24),rowkey1,colkey1)
plateplan2 <-label_plate_rowcol(create_blank_plate(WellR = LETTERS[6:10],WellC=1:24),rowkey2,colkey2)
plateplan3 <-label_plate_rowcol(create_blank_plate(WellR = LETTERS[11:15],WellC=1:24),rowkey3,colkey3)

plateplan_A <- bind_rows(plateplan1, plateplan2, plateplan3)%>% 
    unite(SampleID,Strain,BioRep,remove=FALSE)%>%
    separate(Strain, remove = FALSE,sep="-",into=c("Promoter","mCherry","Terminator","Length"))%>%
      mutate(Ter_length = factor(Length,levels = c("500bp","200bp","86bp","59bp")),remove = FALSE)%>%
    unite(Pro_mCh,Promoter,mCherry,sep="-", remove=FALSE)%>%
      unite(Ter_length, Terminator, Length, sep="-", remove=FALSE)

# Plate plans for plate B (BioRep 4, 5 and 6)
plateplan4 <-label_plate_rowcol(create_blank_plate(WellR = LETTERS[1:5],WellC=1:24),rowkey1,colkey4)
plateplan5 <-label_plate_rowcol(create_blank_plate(WellR = LETTERS[6:10],WellC=1:24),rowkey2,colkey5)
plateplan6 <-label_plate_rowcol(create_blank_plate(WellR = LETTERS[11:15],WellC=1:24),rowkey3,colkey6)

plateplan_B <- bind_rows(plateplan4, plateplan5, plateplan6)%>% 
    unite(SampleID,Strain,BioRep,remove=FALSE)%>%
    separate(Strain, remove = FALSE,sep="-",into=c("Promoter","mCherry","Terminator","Length"))%>%
      mutate(Ter_length = factor(Length,levels = c("500bp","200bp","86bp","59bp")),remove = FALSE)%>%
    unite(Pro_mCh,Promoter,mCherry,sep="-", remove=FALSE)%>%
      unite(Ter_length, Terminator, Length, sep="-", remove=FALSE)
```

```{r plate_plan, fig.height=15,fig.width=25}
display_plate(plateplan_A %>%
                mutate(SampleID=Strain))

display_plate(plateplan_B %>%
                mutate(SampleID=Strain))
```

## Load data and attribute sample information
```{r load_plates,dependson="label_plates",results="show"}
# read my plates
plates_1 <- read_tsv("data/JA_20200830-shortvslong_n1-ct.txt",skip=1) %>%
    mutate(Well=Pos,Cq=Cp,ExpRep = 1,ExpRep=factor(ExpRep)) %>%
    left_join(plateplan_A)

plates_2 <- read_tsv("data/JA_20200831-shortvslong_n2-ct.txt",skip=1) %>%
    mutate(Well=Pos,Cq=Cp,ExpRep = 2,ExpRep=factor(ExpRep)) %>%
    left_join(plateplan_B)

plates <- bind_rows(plates_1, plates_2)
summary(plates)
```

### Plotting unnormalised data for pRPS3-mCh-tRPS3 strains with different lengths of 3'UTRs
- Good that -RT samples all have high Cq values
- No significant batch to batch variability. BioRep 1, 2, 3 (From ExpRep1) vs. BioRep 4, 5, 6 (From ExpRep2) 
```{r unnorm_tRPS3,fig.height=3.5,fig.width=9, echo=FALSE}

ggplot(data=plates%>% filter(Strain %in% c("pRPS3-mCherry-tRPS3_WT-59bp",
                             "pRPS3-mCherry-tRPS3_WT-86bp","pRPS3-mCherry-tRPS3_WT-200bp")), 
     aes(x=TargetID,y=Cq)) +
     geom_point(aes(color=BioRep, shape=Type),
     position=position_dodge(width = 0.85),size=1.6, alpha=0.7) +
     labs(title="Cq values for pRPS3-mCherry-tRPS3 strains comparing different lengths of 3'UTRs",
           y="Quantification cycle (Cq)",
           x="Primers") +
    scale_shape_manual(values=c(16,23)) +
    scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
    facet_wrap(~Strain,ncol=4) +
    theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3),
          legend.position="right")
```

### Plotting unnormalised data for pSRO9-mCh-tSRO9 strains with different lengths of 3'UTRs
- Good that -RT samples all have high Cq values
- No significant batch to batch variability. BioRep 1, 2, 3 (From ExpRep1) vs. BioRep 4, 5, 6 (From ExpRep2) 
```{r unnorm_tSRO9,fig.height=3.5,fig.width=6.5, echo=FALSE}

ggplot(data=plates %>% filter(Strain %in% c("pSRO9-mCherry-tSRO9_WT-200bp",
                              "pSRO9-mCherry-tSRO9_WT-500bp")), 
      aes(x=TargetID,y=Cq)) +
      geom_point(aes(color=BioRep, shape=Type),
      position=position_dodge(width = 0.85),size=1.6, alpha=0.7) +
      labs(title="Cq values for pSRO9-mCherry-tSRO9 strains comparing different lengths of 3'UTRs",
           y="Quantification cycle (Cq)", x="Primers") +
    scale_shape_manual(values=c(16,23)) +
    scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
    facet_wrap(~Strain,ncol=4) +
    theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3),
          legend.position="right")
```



### Plotting unnormalised data for control strains (pRPS3-mCherry-tRPS3_WT-200bp and POT1-ccdB)

```{r unnorm_POT, fig.height=3.5,fig.width=6.5, echo=FALSE}

ggplot(data=plates %>% filter(Strain %in% c("pRPS3-mCherry-tRPS3_WT-200bp","POT1-ccdB")), 
     aes(x=TargetID,y=Cq)) +
     geom_point(aes(color=BioRep, shape=Type),
     position=position_dodge(width = 0.85),size=1.5, alpha=0.7) +
     labs(title="Comparing the Cq value for negative control (POT1-ccdB) with 
          a postive strain (pRPS3-mCherry-tRPS3_WT-200bp)",
          y="Quantification cycle (Cq)",x="Primers") +
    scale_shape_manual(values=c(16,23)) +
    scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
    facet_wrap(~Strain,ncol=2)+
    theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3))
```


## Loading amplification and melt curve data
```{r load_amp-melt,dependson="label_plates", results="show"}

platecurve_A <- read_tsv("data/JA_20200830-shortvslong_n1.txt",skip=2,
                        col_names=c("Well","SID","Program","Segment","Cycle","Time","Temperature","Fluor")) %>%
                        debaseline() %>%left_join(plateplan_A)%>%
                        mutate(ExpRep = 1,ExpRep=factor(ExpRep))
platecurve_B <- read_tsv("data/JA_20200831-shortvslong_n2.txt",skip=2,
                        col_names=c("Well","SID","Program","Segment","Cycle","Time","Temperature","Fluor")) %>%
                        debaseline() %>%left_join(plateplan_B)%>%
                        mutate(ExpRep = 2,ExpRep=factor(ExpRep))
platecurve <- bind_rows(platecurve_A, platecurve_B)
platesamp  <- platecurve %>% filter(Program == 2)
platesmelt <- platecurve %>% filter(Program != 2) %>% getdRdTall() %>% filter(Temperature >= 61)  
```

### Comparing amplification curves of POT1-ccdB strains (all bioreps) with all 5 primers against an mCherry positive strain (pRPS3-mCh-tRPS3_WT-200bp))

```{r plotamp,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesamp %>% filter(Strain==c("POT1-ccdB")),
       aes(x=Cycle,y=Signal,linetype=Type,group=Well, color=ExpRep)) + 
    facet_grid(BioRep~TargetID) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of POT1-ccdB strains (BioRep 1-6)") + panel_border()

ggplot(data=platesamp %>% filter(Strain==c("pRPS3-mCherry-tRPS3_WT-200bp")),
       aes(x=Cycle,y=Signal,linetype=Type,group=Well, color=ExpRep)) + 
    facet_grid(BioRep~TargetID) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of pRPS3-mCherry-tRPS3_WT-200bp strain (BioRep 1-6)") + panel_border()
```


### Comparing melt curves of POT1-ccdB strains (all bioreps) with all 5 primers against an mCherry positive strain (pRPS3-mCh-tRPS3_WT-200bp))

```{r plotmelt,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesmelt %>% filter(Strain==c("POT1-ccdB")),
       aes(x=Temperature,y=dRdT,group=Well)) + 
    facet_grid(BioRep~TargetID) + 
    geom_line(aes(color=ExpRep, linetype=Type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of POT1-ccdB strains (BioRep 1-6)") + panel_border()

ggplot(data=platesmelt %>% filter(Strain==c("pRPS3-mCherry-tRPS3_WT-200bp")),
       aes(x=Temperature,y=dRdT,group=Well)) + 
    facet_grid(BioRep~TargetID) + 
    geom_line(aes(color=ExpRep, linetype=Type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of pRPS3-mCherry-tRPS3_WT strains (BioRep 1-6)") + panel_border()
```

## 1) Delta Cq calculation
Normalisation of all Cq values against the median of Cq values of normalising genes (PGK1-ORF and RPS3-ORF). This calculation takes the **median** of normTargetIDs (getNormCq function default is **median**)

```{r deltaCq_normcalc, echo=TRUE}
# platesnorm normalises the Cq values by the median of normTargetIDs
platesnorm <- plates  %>% 
        filter(!Strain %in% c("POT1-ccdB"), Type=="+RT") %>%    
        normalizeqPCR(normTargetIDs = c("PGK1-ORF", "RPS3-ORF")) 

platesnorm_summarise <- platesnorm%>%
                    group_by(Strain, TargetID, BioRep, ExpRep)%>%
                    summarize(Median_deltaCq = median(Value.norm, na.rm=TRUE),
                              RNA_Abundance = (2^-Median_deltaCq), na.rm=FALSE)%>% 
                    ungroup(Strain)%>%
    mutate(Strain = factor(Strain,levels = c("pRPS3-mCherry-tRPS3_WT-59bp", 
                                             "pRPS3-mCherry-tRPS3_WT-86bp", "pRPS3-mCherry-tRPS3_WT-200bp",
                                             "pSRO9-mCherry-tSRO9_WT-200bp", "pSRO9-mCherry-tSRO9_WT-500bp")),
           TargetID = factor (TargetID, levels = c("PGK1-ORF", "SRO9-ORF", "RPS3-ORF",
                                                   "URA3-ORF", "mCh-7")))%>%
    separate(Strain, remove = FALSE,sep="-",into=c("Promoter","mCherry","Terminator","Length"))%>%
    mutate(Ter_length = factor(Length,levels = c("500bp","200bp","86bp","59bp")),remove = FALSE)%>%
    unite(Pro_mCh,Promoter,mCherry,sep="-", remove=FALSE)%>%
    unite(Ter_length, Terminator, Length, sep="-", remove=FALSE)
```

### 1) Exporting analysed data
```{r deltaCq_csv_export}
#exporting platesnorm_summarise dataframe
write.csv(platesnorm_summarise,"analysed_data/platesnorm_summarise.csv", row.names = FALSE)
```

```{r deltaCq_plot-all, fig.height=6, fig.width=9}

ggplot(platesnorm, aes(Ter_length,Value.norm))+
  geom_point(aes(color=BioRep),position=position_dodge(width = 0.85),size=1.2, alpha=0.7)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  labs(y="delta Cq", x="3'UTR-terminators")+
  facet_wrap(~TargetID)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 
```

```{r deltaCq_plot-pRPS3, fig.height=6, fig.width=8}

ggplot(platesnorm %>% filter(Promoter %in% c("pRPS3")), aes(Ter_length,Value.norm))+
  geom_point(aes(color=BioRep),position=position_dodge(width = 0.8),size=1.5, alpha=0.7)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  ylim(-6,6)+
  labs(y="delta Cq", x="3'UTR-terminators")+
  facet_wrap(~TargetID)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 
```


```{r deltaCq_plot-pSRO9, fig.height=6, fig.width=7}

ggplot(platesnorm %>% filter(Promoter %in% c("pSRO9")), aes(Ter_length,Value.norm))+
  geom_point(aes(color=BioRep),position=position_dodge(width = 0.8),size=1.5, alpha=0.7)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  ylim(-6,6)+
  labs(y="delta Cq", x="3'UTR-terminators")+
  facet_wrap(~TargetID)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 
```

### Comparing distributions of data points between experimental replicates (done in 2 different days)
- There doesn't seem to be much of a difference between ExpRep distributions (no batch-to-batch variances)
```{r deltaCq_comparison, echo=TRUE, fig.height=4, fig.width=5}

ggplot(platesnorm %>% filter(TargetID %in% 'mCh-7'), aes(Ter_length,Value.norm))+
  geom_point(aes(color=ExpRep),position=position_dodge(width = 0.85),size=1.2, alpha=1)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  labs(y="delta Cq", x="3'UTR-terminators")+
  #facet_wrap(~Promoter)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 
```

### Plotting summary values of each biorep for each pRPS3 strain
- for URA3-ORF for pRPS3-mCherry-tRPS3_WT-200bp seems to have a higher delta Cq than pRPS3-mCherry-tRPS3_WT-59bp and pRPS3-mCherry-tRPSS3_WT-86bp. **Perhaps its worth considering a way of normalising the mCherry against URA3?**
```{r deltaCq_Exp_pRPS3, fig.width=6, fig.height=9.5}

normalised_Exp_pRPS3 <- ggplot(data = platesnorm_summarise %>% filter(Promoter %in% 'pRPS3'))+
    geom_point(aes(RNA_Abundance,TargetID,colour=TargetID, shape=BioRep)) +
    scale_x_log2nice(name="2^deltaCq (log2 scale)",omag = seq(-5,5),scilabels=FALSE) +
    labs(y="") +
    scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    scale_colour_manual(values=c("#416db0", "#6f3ba1", "#a84a9a", "black","#CC6666")) +
    guides(colour=FALSE) +
    theme(axis.text.y=element_text(colour=c("#416db0", "#6f3ba1", "#a84a9a", "black","#CC6666")),
          axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(size=10,vjust=-2),
          legend.position="right")+
    facet_wrap(~Strain,ncol = 1)

normalised_Exp_pRPS3 + stat_summary(aes(RNA_Abundance,TargetID),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 
```

### Plotting summary values of each biorep for each pSRO9 strain
```{r deltaCq_Exp_pSRO9, fig.width=6, fig.height=6.5}

normalised_Exp_pRPS3 <- ggplot(data = platesnorm_summarise %>% filter(Promoter %in% 'pSRO9'))+
    geom_point(aes(RNA_Abundance,TargetID,colour=TargetID, shape=BioRep)) +
    scale_x_log2nice(name="2^deltaCq (log2 scale)",omag = seq(-5,5),scilabels=TRUE) +
    labs(y="") +
    scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    scale_colour_manual(values=c("#416db0", "#6f3ba1", "#a84a9a", "black","#CC6666")) +
    guides(colour=FALSE) +
    theme(axis.text.y=element_text(colour=c("#416db0", "#6f3ba1", "#a84a9a", "black","#CC6666")),
          axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(size=10,vjust=-2),
          legend.position="right")+
    facet_wrap(~Strain,ncol = 1)

normalised_Exp_pRPS3 + stat_summary(aes(RNA_Abundance,TargetID),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 
```

## 2) Delta-delta Cq and RNA abundance calculation (Relatiive to full 3'UTR construct) - normalised within each experimental replicate

```{r delta-deltaCq_SRO9norm, echo=TRUE}
# Extracting data for pSRO9 strains
platesnorm_pSRO9_ExpRep <- platesnorm %>% filter(Promoter %in% "pSRO9", TargetID %in% "mCh-7")

# Calculates the mean Cq value of pSRO9-mCherry-tSRO9_WT-500bp Strain (4.111667)
mean_platesnorm_S500bp_ExpRep1 <- platesnorm_pSRO9_ExpRep %>% filter(ExpRep==1)%>%
    select(c("Strain","Value.norm", "BioRep", "TechRep")) %>% 
    filter(Strain %in% c("pSRO9-mCherry-tSRO9_WT-500bp")) %>%
    group_by(Strain, BioRep)%>%
    summarize(median_BioRep_S500bp = median(Value.norm)) %>%
    ungroup()%>%
    group_by(Strain)%>%
    summarize(mean_S500bp = mean(median_BioRep_S500bp))

# Calculates the mean Cq value of pSRO9-mCherry-tSRO9_WT-500bp Samples (4.035)
mean_platesnorm_S500bp_ExpRep2 <- platesnorm_pSRO9_ExpRep %>% 
                                          filter(ExpRep==2)%>%
    select(c("Strain","Value.norm", "BioRep", "TechRep")) %>% 
    filter(Strain %in% c("pSRO9-mCherry-tSRO9_WT-500bp")) %>%
    group_by(Strain, BioRep)%>%
    summarize(median_BioRep_S500bp = median(Value.norm)) %>%
    ungroup()%>%
    group_by(Strain)%>%
    summarize(mean_S500bp = mean(median_BioRep_S500bp))

# Calculates the delta delta Cq (subtracts mean(mean_tSRO9500bp$Value.norm) from every Value.norm))
platesnorm_by_S500bp_pSRO9_ExpRep1 <- platesnorm_pSRO9_ExpRep %>% filter(ExpRep==1)%>%
    mutate(Value.norm.S500bp = Value.norm - mean_platesnorm_S500bp_ExpRep1$mean_S500bp, remove=FALSE)
platesnorm_by_S500bp_pSRO9_ExpRep2 <- platesnorm_pSRO9_ExpRep %>% filter(ExpRep==2)%>%
    mutate(Value.norm.S500bp = Value.norm - mean_platesnorm_S500bp_ExpRep2$mean_S500bp, remove=FALSE)
```


```{r delta-deltaCq_RPS3norm, echo=TRUE}

# Extracting data for pRPS3 strains
platesnorm_pRPS3_ExpRep <- platesnorm %>% filter(Promoter %in% "pRPS3", TargetID %in% "mCh-7")

# Calculates the mean Cq value of pRPS3-mCherry-tRPS3_WT-200bp Strain (-1.12)
mean_platesnorm_R200bp_ExpRep1 <- platesnorm_pRPS3_ExpRep %>% filter(ExpRep==1)%>%
    select(c("Strain","Value.norm", "BioRep", "TechRep")) %>% 
    filter(Strain %in% c("pRPS3-mCherry-tRPS3_WT-200bp")) %>%
    group_by(Strain, BioRep)%>%
    summarize(median_BioRep_R200bp = median(Value.norm)) %>%
    ungroup()%>%
    group_by(Strain)%>%
    summarize(mean_R200bp = mean(median_BioRep_R200bp))

# Calculates the mean Cq value of pRPS3-mCherry-tRPS3_WT-200bp Samples (-0.9216667)
mean_platesnorm_R200bp_ExpRep2 <- platesnorm_pRPS3_ExpRep %>% 
                                          filter(ExpRep==2)%>%
    select(c("Strain","Value.norm", "BioRep", "TechRep")) %>% 
    filter(Strain %in% c("pRPS3-mCherry-tRPS3_WT-200bp")) %>%
    group_by(Strain, BioRep)%>%
    summarize(median_BioRep_R200bp = median(Value.norm)) %>%
    ungroup()%>%
    group_by(Strain)%>%
    summarize(mean_R200bp = mean(median_BioRep_R200bp))

# Calculates the delta delta Cq (subtracts mean(mean_tSRO9500bp$Value.norm) from every Value.norm))
platesnorm_by_R200bp_pRPS3_ExpRep1 <- platesnorm_pRPS3_ExpRep %>% filter(ExpRep==1)%>%
    mutate(Value.norm.R200bp = Value.norm - mean_platesnorm_R200bp_ExpRep1$mean_R200bp, remove=FALSE)
platesnorm_by_R200bp_pRPS3_ExpRep2 <- platesnorm_pRPS3_ExpRep %>% filter(ExpRep==2)%>%
    mutate(Value.norm.R200bp = Value.norm - mean_platesnorm_R200bp_ExpRep2$mean_R200bp, remove=FALSE)
```

## 2) Summarise delta delta Cq (Mean delta delta Cq) and RNA abundance calculation
In the previous 2 chunks, we have calculated the delta-delta Cq value for each techrep. Here, we are summarising that information by calculating the median Cq for each biorep and calculating the RNA abundance (2^-Median_Cq).  

```{r mean_rna_abund_ExpRep, echo=TRUE}

platesnorm_S500bp_pSRO9_median <- bind_rows(platesnorm_by_S500bp_pSRO9_ExpRep1,platesnorm_by_S500bp_pSRO9_ExpRep2)%>%
                    group_by(Strain, TargetID, BioRep, ExpRep)%>%
                    summarize(Median_delta_deltaCq = median(Value.norm.S500bp, na.rm=TRUE),
                              RNA_Abundance = (2^-Median_delta_deltaCq), na.rm=FALSE)%>%
                    separate(Strain, remove = FALSE,sep="-",into=c("Promoter","mCherry","Terminator", "Length")) %>%
                    unite(Pro_mCh,Promoter,mCherry,sep="-", remove=FALSE)%>%
                    unite(Ter_length,Terminator,Length,sep="_", remove=FALSE)


platesnorm_R200bp_pRPS3_median <- bind_rows(platesnorm_by_R200bp_pRPS3_ExpRep1,platesnorm_by_R200bp_pRPS3_ExpRep2)%>%
                    group_by(Strain, TargetID, BioRep, ExpRep)%>%
                    summarize(Median_delta_deltaCq = median(Value.norm.R200bp, na.rm=TRUE),
                              RNA_Abundance = (2^-Median_delta_deltaCq), na.rm=FALSE)%>%
                    ungroup(Strain)%>%
                    mutate(Strain = factor(Strain,levels = c("pRPS3-mCherry-tRPS3_WT-86bp", "pRPS3-mCherry-tRPS3_WT-59bp", 
                                             "pRPS3-mCherry-tRPS3_WT-200bp")))%>%
                    separate(Strain, remove = FALSE,sep="-",into=c("Promoter","mCherry","Terminator", "Length")) %>%
                    unite(Pro_mCh,Promoter,mCherry,sep="-", remove=FALSE)%>%
                    unite(Ter_length,Terminator,Length,sep="_", remove=FALSE)


platesnorm_all_median <- bind_rows(platesnorm_S500bp_pSRO9_median,platesnorm_R200bp_pRPS3_median)
```

### 2) Exporting analysed data
```{r delta_deltaCq_csv_export}
#exporting platesnorm_all_median dataframe
write.csv(platesnorm_all_median,"analysed_data/platesnorm_all_median.csv", row.names = FALSE)
```

### 2B) Plotting the results in a scatter plot

```{r norm_plot_SRO9,fig.height=2.5,fig.width=6.5, echo=FALSE}

normalised_plot_SRO9 <- ggplot(data = platesnorm_S500bp_pSRO9_median)+
    geom_point(aes(RNA_Abundance,Strain,colour=Ter_length, shape=BioRep)) +
    scale_x_log2nice(name="Fold change in RNA abundance relative to \n pSRO9-mCh-tSRO9_500bp (log2 scale)",
                     omag = seq(-5,5),scilabels=FALSE) +
      labs(y="") +
    scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    scale_colour_manual(values=c("#CC6666", "black")) +
    guides(colour=FALSE) +
    theme(axis.text.y=element_text(colour=c("#CC6666", "black")),
          axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          legend.position="right")
  #facet_wrap(~Pro_mCh,ncol = 2)

normalised_plot_SRO9 + stat_summary(aes(RNA_Abundance,Strain),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 
```
```{r norm_plot_RPS3,fig.height=3.5,fig.width=6.5, echo=FALSE}

normalised_plot_RPS3 <- ggplot(data = platesnorm_R200bp_pRPS3_median)+
    geom_point(aes(RNA_Abundance,Strain,colour=Ter_length, shape=BioRep)) +
    scale_x_log2nice(name="Fold change in RNA abundance relative to \n pRPS3-mCh-tRPS3_200bp (log2 scale)",
                     omag = seq(-5,5),scilabels=FALSE) +
      labs(y="") +
    scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    scale_colour_manual(values=c("#288a2e","#a84a9a","#6f3ba1")) +
    guides(colour=FALSE) +
    theme(axis.text.y=element_text(colour=c("#6f3ba1","#a84a9a", "#288a2e")),
          axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          legend.position="right")

normalised_plot_RPS3 + stat_summary(aes(RNA_Abundance,Strain),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 
```