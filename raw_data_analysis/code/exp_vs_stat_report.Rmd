---
title: "Chimera construct mTurq and mCherry fluorescence during exponential and stationary phases"
author: "Sam Haynes"
date: '2022-07-28'
output: pdf_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tibble)
library(readr)
library(here)
library(ggplot2)
library(tidyr)
library(latex2exp)
library(stringr)

source(here("raw_data_analysis/code/shared_figure_formatting.R"))

# define promoter and terminator levels in desired order
pro6  <- c("pPGK1", "pHSP26", "pRPS3", "pRPS13", "pSRO9", "pCLN2")
pro4  <- c("pPGK1", "pHSP26", "pRPS3", "pRPS13")
ter10 <- rev(c("tPGK1", "tRPS3", "tRPS13",
           "tPAB1", "tHSP26", 
           "tCLN2", "tSRO9", 
           "tTOS6", "tSUN4", "tPMA1"))
mTurq_stat_phase_time <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mTurq_collection/pro-mTurq-ter_swaps_max_gr.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mTurq-", remove = FALSE) %>%
  filter(!is.na(Terminator)) %>%
  transmute(experiment, strain, Promoter, Terminator, time =  as.double(`time of max gr`),
            Growth = "Exp")

mCherry_stat_phase_time <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mCherry_collection/pro-mCherry-ter_swaps_max_gr.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mCherry-", remove = FALSE) %>%
  filter(!is.na(Terminator)) %>%
  transmute(experiment, strain, Promoter, Terminator, time =  as.double(`time of max gr`),
            Growth = "Exp") %>%
  mutate(Terminator = str_remove_all(Terminator, "_biorep[123456789]"))

pro_mTurq_ter_all_stat_phase <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mTurq_collection/pro-mTurq-ter_swaps_OD_and_mTurq.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mTurq-", remove = FALSE)

pro_mCherry_ter_all_stat_phase <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mCherry_collection/pro-mCherry-ter_swaps_OD_and_mCherry.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mCherry-", remove = FALSE) %>%
  mutate(Terminator = str_remove_all(Terminator, "_biorep[123456789]"))
```

# Using OD to detect stationary and exponential growth phases

The gradient of the OD curve (the growth rate) is used to determine time points that represent the stationary and exponential growth phases of the samples. The time chosen to represent exponential growth is the time of maximum growth rate (largest gradient of OD curve). The time chosen to represent stationary phase is 12 hours after the exponential growth phase. The graph below shows the chosen stationary (dotted line) and exponential (solid line) time points across bioreps for a handful of chimera strains.


```{r selecting-stat-and-exp-times, echo=FALSE, warning=FALSE, message=FALSE}
mTurq_stat_and_exp_phase_time <- mTurq_stat_phase_time %>%
  bind_rows(mTurq_stat_phase_time %>%
              mutate(time = time + 12, Growth = "Stat"))

mCherry_stat_and_exp_phase_time <- mCherry_stat_phase_time %>%
  bind_rows(mCherry_stat_phase_time %>%
              mutate(time = time + 12, Growth = "Stat"))


  
ggplot(pro_mTurq_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `OD mean`, colour = experiment),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mTurq_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator) +
  labs(title = "mTurq: Selected stationary and exponential phase timepoints",
       y = "OD")

ggplot(pro_mCherry_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `OD mean`, colour = experiment),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mCherry_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator) +
  labs(title = "mCherry: Selected stationary and exponential phase timepoints",
       y = "OD")
```

## Fluorescence of high expressing promoters across growth stages

The fluorescence per od of RPS3, RPS13, PGK1 and HSP26 promoter chimeras across the two time points. With mTurq, the figure below suggests that the ribosomal promoters have steady expression across the two timepoints. However, HSP26 and PGK1 increase expression dramatically between stationary and exponential phases. On the other hand, mCherry fluorescence suggests most promoters do not change across time points. Except for pHSP26 which appears to reduce in expression during stationary phase.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
high_exp_pro_mTurq <- pro_mTurq_ter_all_stat_phase %>%
  filter(!Promoter %in% c("pSRO9", "pCLN2"))

high_exp_pro_mCherry <- pro_mCherry_ter_all_stat_phase %>%
  filter(!Promoter %in% c("pSRO9", "pCLN2"))

mTurq_stat_phase<- mTurq_stat_and_exp_phase_time %>%
  pivot_wider(names_from = Growth, values_from = time) %>%
  inner_join(high_exp_pro_mTurq) %>%
  group_by(Promoter, Terminator, experiment) %>%
  summarise(fluo_per_OD_at_max_gr = (`c-mTurq-60perod`[time > Exp])[1], Growth = "Exponential") %>%
  bind_rows(mTurq_stat_and_exp_phase_time %>%
              pivot_wider(names_from = Growth, values_from = time) %>%
              inner_join(high_exp_pro_mTurq) %>%
              group_by(Promoter, Terminator, experiment) %>%
              summarise(fluo_per_OD_at_max_gr = (`c-mTurq-60perod`[time > Stat])[1], Growth = "Stationary")) %>%
    ungroup() %>%
  mutate(Protein = "mTurq")

mCherry_stat_phase <- mCherry_stat_and_exp_phase_time %>%
  pivot_wider(names_from = Growth, values_from = time) %>%
  inner_join(high_exp_pro_mCherry) %>%
  group_by(Promoter, Terminator, strain) %>%
  summarise(fluo_per_OD_at_max_gr = (`c-mCherry-100perod`[time > Exp])[1], Growth = "Exponential") %>%
  bind_rows(mCherry_stat_and_exp_phase_time %>%
              pivot_wider(names_from = Growth, values_from = time) %>%
              inner_join(high_exp_pro_mCherry) %>%
              group_by(Promoter, Terminator, strain) %>%
              summarise(fluo_per_OD_at_max_gr = (`c-mCherry-100perod`[time > Stat])[1], Growth = "Stationary")) %>%
    ungroup() %>%
  mutate(Protein = "mCherry")

norm_mCherry_stat_phase <- mCherry_stat_phase %>%
  mutate(biorep = str_extract(strain, "[123456789]$")) %>%
  filter(biorep < 6) %>%
  group_by(biorep, Promoter, Growth) %>%
  mutate(`fluo_per_OD_at_max_gr` = `fluo_per_OD_at_max_gr`/`fluo_per_OD_at_max_gr`[Terminator == "tPGK1"])

norm_mTurq_stat_phase <- mTurq_stat_phase %>%
  group_by(experiment, Promoter, Growth) %>%
  mutate(`fluo_per_OD_at_max_gr` = `fluo_per_OD_at_max_gr`/`fluo_per_OD_at_max_gr`[Terminator == "tPGK1"])

ggplot(mTurq_stat_phase) +
  geom_vline1 + 
  geom_point(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator),
             shape = 18, size = 2) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr),
               fun="mean",colour="black",
               geom="crossbar", size=0.3, width=0.9) +
  theme(legend.position = "none",
        strip.text.x = element_text(vjust = 0.95)) +
  scale_x_continuous(oob=oob_squish, limits = c(0,NA), breaks = c(0, 10000, 20000, 30000), labels = c(0, "", 20000, "")) +
  facet_grid(Growth~Promoter) +
  labs(x="Fluorescence per OD",
       title="mTurq: Fluorescence per OD at Exp and Stat growth stages") 

ggplot(mCherry_stat_phase) +
  geom_vline1 + 
  geom_point(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator),
             shape = 18, size = 2) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr),
               fun="mean",colour="black",
               geom="crossbar", size=0.3, width=0.9) +
  theme(legend.position = "none",
        strip.text.x = element_text(vjust = 0.95)) +
  scale_x_continuous(oob=oob_squish, limits = c(0,NA), breaks = c(0, 10000, 20000, 30000), labels = c(0, "", 20000, "")) +
  facet_grid(Growth~Promoter) +
  labs(x="Fluorescence per OD",
       title="mCherry: Fluorescence per OD at Exp and Stat growth stages") 

```

## Terminator luorescence normalised to tPGK1 across growth stages
Normalising the fluorescence of all terminators paired with a promoter to the PGK1 promoter-terminator pair shows little difference in terminator expression levels across the time points.

```{r, echo=FALSE, message=FALSE, warning=FALSE}

ggplot(data=norm_mTurq_stat_phase) +
  labs(x="Relative fluorescence per OD relative to tPGK1", y="Terminator",
       title="mTurq: Normalised fluorescence per OD at Exp and Stat growth stages") +
  facet_grid(Protein~Promoter) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  geom_vline1 +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator, shape = Growth),
               fun.data="mean_se",
               geom="pointrange") +
  theme(strip.text.x = element_text(vjust = 0.95)) +
  guides(colour = "none") +
  scale_x_continuous(oob=oob_squish, limits = c(0,1.9))

ggplot(data=norm_mCherry_stat_phase) +
  labs(x="Relative fluorescence per OD relative to tPGK1", y="Terminator",
       title="mCherry: Normalised fluorescence per OD at Exp and Stat growth stages") +
  facet_grid(Protein~Promoter) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  geom_vline1 +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator, shape = Growth),
               fun.data="mean_se",
               geom="pointrange") +
  theme(strip.text.x = element_text(vjust = 0.95)) +
  guides(colour = "none") +
  scale_x_continuous(oob=oob_squish, limits = c(0,1.9))
```

# Conclusion
We have detected differences in promoter expression levels across time points with mTurq but not with mCherry. As Jamie has eluded to previously, the maturation time of the two fluorophores differs significantly. I am not entirely sure what to conclude from these results. Could maturation effects be cancelling out time based effects in mCherry or could it be introducing a false signal in mTurq? 