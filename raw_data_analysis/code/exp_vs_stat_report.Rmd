---
title: "Chimera construct mTurq and mCherry fluorescence during exponential and stationary phases"
author: "Sam Haynes"
date: '2022-07-28'
output: pdf_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tibble)
library(readr)
library(here)
library(ggplot2)
library(tidyr)
library(latex2exp)
library(stringr)

source(here("raw_data_analysis/code/shared_figure_formatting.R"))

# define promoter and terminator levels in desired order
pro6  <- c("pPGK1", "pHSP26", "pRPS3", "pRPS13", "pSRO9", "pCLN2")
pro4  <- c("pPGK1", "pHSP26", "pRPS3", "pRPS13")
ter10 <- rev(c("tPGK1", "tRPS3", "tRPS13",
           "tPAB1", "tHSP26", 
           "tCLN2", "tSRO9", 
           "tTOS6", "tSUN4", "tPMA1"))
mTurq_stat_phase_time <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mTurq_collection/pro-mTurq-ter_swaps_max_gr.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mTurq-", remove = FALSE) %>%
  filter(!is.na(Terminator)) %>%
  transmute(experiment, strain, Promoter, Terminator, time =  as.double(`time of max gr`),
            Growth = "Exp")

mCherry_stat_phase_time <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mCherry_collection/pro-mCherry-ter_swaps_max_gr.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mCherry-", remove = FALSE) %>%
  filter(!is.na(Terminator)) %>%
  transmute(experiment, strain, Promoter, Terminator, time =  as.double(`time of max gr`),
            Growth = "Exp") %>%
  mutate(Terminator = str_remove_all(Terminator, "_biorep[123456789]"))

pro_mTurq_ter_all_stat_phase <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mTurq_collection/pro-mTurq-ter_swaps_OD_and_mTurq.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mTurq-", remove = FALSE)

pro_mCherry_ter_all_stat_phase <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mCherry_collection/pro-mCherry-ter_swaps_OD_and_mCherry.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mCherry-", remove = FALSE) %>%
  separate(Terminator, into = c("Terminator", "Biorep"), sep = "_biorep")
```

# Aim
- Determine if promoters or terminators display different expression patterns across the 16 hour platereader experiment

# Overview
We have a library of 120 'chimera' constructs consisting of all combinations of 10 terminators, 6 promoters and 2 fluorescence protein ORFs. The two fluorescent proteins are mCherry and mTurq. We measured fluorescence over a 16 hour period using a platereader and analysed the results with the Omniplate software to determine the fluorescence per OD at max growth rate. Our primary analysis consisted of determining if terminators change their contributions to gene expression according to what promoter and ORF they are paired with. 

We now want to see if promoters or terminators express differently at different time points. For example, as a stress response gene HSP26 would be expected to increase expression as the cells shift from exponential to stationary growth phases. Ribosomal genes like RPS3 and RPS13 should remain constant throughout. We have picked a time point to represent the start of the stationary phase and can see a significant change in mTurq fluorescence per OD for pHSP26 between exponential and stationary growth phases, but not pRPS3 and pRPS13. Unfortunately, the results between mCherry and mTurq do not correlate at the stationary phase time point. Therefore, we are not sure if the mTurq results are correct and if there is something wrong with the mCherry results. We have outlined our results and methods below in the hopes that you may be able to suggest an explaination.

# Results

## Using OD to select stationary and exponential growth phases

The time chosen to represent exponential growth is the time of maximum growth rate as calculated by Omniplate. The time chosen to represent stationary phase is when the OD is first detected to reach 0.6. We chose an OD of 0.6 because we wanted the last time point before OD becomes saturated (so we could still normalise fluorescence by OD). The graph below shows the chosen stationary (dotted line) and exponential (solid line) time points across bioreps for a handful of chimera strains.

```{r od-graphs, echo=FALSE, message=FALSE, warning=FALSE}
mTurq_stat_and_exp_phase_time <- mTurq_stat_phase_time %>%
  bind_rows(pro_mTurq_ter_all_stat_phase %>%
              filter(`OD mean` > 0.6, !is.na(Terminator)) %>%
              group_by(experiment, strain, Promoter, Terminator) %>%
              summarise(time = time[1]) %>%
              mutate(Growth = "Stat"))

mCherry_stat_and_exp_phase_time <- mCherry_stat_phase_time %>%
  bind_rows(pro_mCherry_ter_all_stat_phase %>%
                       filter(`OD mean` > 0.6, !is.na(Terminator)) %>%
                       group_by(experiment, strain, Promoter, Terminator) %>%
                       summarise(time = time[1]) %>% 
                       mutate(Growth = "Stat"))

ggplot(pro_mTurq_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `OD mean`, colour = experiment),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mTurq_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator,
             scales = "free_y") +
  labs(title = "mTurq: Selected stationary and exponential phase timepoints",
       y = "OD")

ggplot(pro_mCherry_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `OD mean`, colour = Biorep),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mCherry_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator,
             scales = "free_y") +
  labs(title = "mCherry: Selected stationary and exponential phase timepoints",
       y = "OD mean")
```

## Fluorescence of high expressing promoters across growth stages

The fluorescence per od of RPS3, RPS13, PGK1 and HSP26 promoter chimeras across the two time points. With mTurq, the figure below suggests that the ribosomal promoters have steady expression across the two timepoints. However, HSP26 and PGK1 increase expression between stationary and exponential phases. On the other hand, mCherry fluorescence suggests most promoters do not change across time points. Except for pHSP26 which appears to reduce in expression during stationary phase.

```{r paper-figure, echo=FALSE, message=FALSE, warning=FALSE}
high_exp_pro_mTurq <- pro_mTurq_ter_all_stat_phase %>%
  filter(!Promoter %in% c("pSRO9", "pCLN2"))

high_exp_pro_mCherry <- pro_mCherry_ter_all_stat_phase %>%
  filter(!Promoter %in% c("pSRO9", "pCLN2"))

mTurq_stat_phase<- mTurq_stat_and_exp_phase_time %>%
  pivot_wider(names_from = Growth, values_from = time) %>%
  inner_join(high_exp_pro_mTurq) %>%
  group_by(Promoter, Terminator, experiment, strain) %>%
  summarise(fluo_per_OD_at_max_gr = (`c-mTurq-60perod`[time > Exp])[1], Growth = "Exponential") %>%
  bind_rows(mTurq_stat_and_exp_phase_time %>%
              pivot_wider(names_from = Growth, values_from = time) %>%
              inner_join(high_exp_pro_mTurq) %>%
              group_by(Promoter, Terminator, experiment) %>%
              summarise(fluo_per_OD_at_max_gr = (`c-mTurq-60perod`[time > Stat])[1], Growth = "Stationary")) %>%
    ungroup() %>%
  mutate(Protein = "mTurq")

mCherry_stat_phase <- mCherry_stat_and_exp_phase_time %>%
  pivot_wider(names_from = Growth, values_from = time) %>%
  inner_join(high_exp_pro_mCherry) %>%
  group_by(Promoter, Terminator, experiment, strain) %>%
  summarise(fluo_per_OD_at_max_gr = (`c-mCherry-100perod`[time > Exp])[1], Growth = "Exponential") %>%
  bind_rows(mCherry_stat_and_exp_phase_time %>%
              pivot_wider(names_from = Growth, values_from = time) %>%
              inner_join(high_exp_pro_mCherry) %>%
              group_by(Promoter, Terminator, experiment, strain) %>%
              summarise(fluo_per_OD_at_max_gr = (`c-mCherry-100perod`[time > Stat])[1], Growth = "Stationary")) %>%
    ungroup() %>%
  mutate(Protein = "mCherry")

norm_mCherry_stat_phase <- mCherry_stat_phase %>%
  mutate(biorep = str_extract(strain, "[123456789]$")) %>%
  filter(biorep < 6) %>%
  group_by(biorep, Promoter, Growth) %>%
  mutate(`fluo_per_OD_at_max_gr` = `fluo_per_OD_at_max_gr`/`fluo_per_OD_at_max_gr`[Terminator == "tPGK1"])

norm_mTurq_stat_phase <- mTurq_stat_phase %>%
  group_by(experiment, Promoter, Growth) %>%
  mutate(`fluo_per_OD_at_max_gr` = `fluo_per_OD_at_max_gr`/`fluo_per_OD_at_max_gr`[Terminator == "tPGK1"])

ggplot(mTurq_stat_phase) +
  geom_vline1 + 
  geom_point(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator),
             shape = 18, size = 2) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr),
               fun="mean",colour="black",
               geom="crossbar", size=0.3, width=0.9) +
  theme(legend.position = "none",
        strip.text.x = element_text(vjust = 0.95)) +
  scale_x_continuous(oob=oob_squish, limits = c(0,NA), breaks = c(0, 10000, 20000, 30000), labels = c(0, "", 20000, "")) +
  facet_grid(Growth~Promoter) +
  labs(x="Fluorescence per OD",
       title="mTurq: Fluorescence per OD at Exp and Stat growth stages") 

ggplot(mCherry_stat_phase) +
  geom_vline1 + 
  geom_point(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator),
             shape = 18, size = 2) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr),
               fun="mean",colour="black",
               geom="crossbar", size=0.3, width=0.9) +
  theme(legend.position = "none",
        strip.text.x = element_text(vjust = 0.95)) +
  scale_x_continuous(oob=oob_squish, limits = c(0,NA), breaks = c(0, 10000, 20000, 30000), labels = c(0, "", 20000, "")) +
  facet_grid(Growth~Promoter) +
  labs(x="Fluorescence per OD",
       title="mCherry: Fluorescence per OD at Exp and Stat growth stages") 

```

# Comparing differences in fluorescence curves with each fluorescent protein

The differences in the mCherry and mTurq results are reflected in the fluorescence curves for each construct. The mTurq fluorescence per OD time course shows the fluorescence increasing with time for all constructs after 5 hours have past. Interestingly, the HSP26 promoter constructs all seem to have a later point of inflection than other promoters suggesting it is expressed at a later time point. The mCherry fluorescence per OD time course shows a very different picture with very few constructs showing significant increases over time. Comparing fluorescence curves before normalising with OD shows that mCherry is more noisy and has lower fluorescence than mTurq. However, we're not sure how this could lead to such different results across the exponential and stationary phase time points. 

```{r selecting-stat-and-exp-times, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(pro_mTurq_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `c-mTurq-60perod`, colour = experiment),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mTurq_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator,
             scales = "free_y") +
  labs(title = "mTurq: Fluorescence per OD time course",
       y = "c-mTurq-60perod")

ggplot(pro_mCherry_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `c-mCherry-100perod`, colour = Biorep),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mCherry_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator,
             scales = "free_y") +
  labs(title = "mCherry: Fluorescence per OD time course",
       y = "c-mCherry-100-perod")
```

```{r fluorescence-graphs, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(pro_mTurq_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `c-mTurq-60`, colour = experiment),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mTurq_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator,
             scales = "free_y") +
  labs(title = "mTurq: Fluorescence time course",
       y = "c-mTurq-60")

ggplot(pro_mCherry_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `c-mCherry-100`, colour = Biorep),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mCherry_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator,
             scales = "free_y") +
  labs(title = "mCherry: Fluorescence time course",
       y = "c-mCherry-100")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval = FALSE}

ggplot(data=norm_mTurq_stat_phase) +
  labs(x="Relative fluorescence per OD relative to tPGK1", y="Terminator",
       title="mTurq: Normalised fluorescence per OD at Exp and Stat growth stages") +
  facet_grid(Protein~Promoter) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  geom_vline1 +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator, shape = Growth),
               fun.data="mean_se",
               geom="pointrange") +
  theme(strip.text.x = element_text(vjust = 0.95)) +
  guides(colour = "none") +
  scale_x_continuous(oob=oob_squish, limits = c(0,1.9))

ggplot(data=norm_mCherry_stat_phase) +
  labs(x="Relative fluorescence per OD relative to tPGK1", y="Terminator",
       title="mCherry: Normalised fluorescence per OD at Exp and Stat growth stages") +
  facet_grid(Protein~Promoter) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  geom_vline1 +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator, shape = Growth),
               fun.data="mean_se",
               geom="pointrange") +
  theme(strip.text.x = element_text(vjust = 0.95)) +
  guides(colour = "none") +
  scale_x_continuous(oob=oob_squish, limits = c(0,1.9))
```

# Conclusion
We have detected differences in promoter expression levels across time points with mTurq but not with mCherry. We are not entirely sure what to conclude from these results. Are the mCherry results invalid? Is it reasonable to try and determine changes in expression across time given the mTurq results? Maybe we could valid our findings using flow cytometry with a small subset of constructs?