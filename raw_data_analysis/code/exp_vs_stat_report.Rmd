---
title: "Chimera construct fluorescence during exponential and stationary phases"
author: "Sam Haynes"
date: '2022-07-28'
output: pdf_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tibble)
library(readr)
library(here)
library(ggplot2)
library(tidyr)
library(latex2exp)

source(here("raw_data_analysis/code/shared_figure_formatting.R"))

# define promoter and terminator levels in desired order
pro6  <- c("pPGK1", "pHSP26", "pRPS3", "pRPS13", "pSRO9", "pCLN2")
pro4  <- c("pPGK1", "pHSP26", "pRPS3", "pRPS13")
ter10 <- rev(c("tPGK1", "tRPS3", "tRPS13",
           "tPAB1", "tHSP26", 
           "tCLN2", "tSRO9", 
           "tTOS6", "tSUN4", "tPMA1"))

pro_mTurq_ter_protein <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mTurq_collection/pro-mTurq-ter_swaps_raw.csv"))%>%
  mutate(Promoter = factor(Promoter, levels = pro6),
         Terminator = factor(Terminator, levels = ter10)) %>% 
  rename(fluo_per_OD_at_max_gr = "mTurq_per_OD_at_max_gr", Protein = "mTurq") %>%
  select(-X1)

mTurq_stat_phase_time <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mTurq_collection/pro-mTurq-ter_swaps_max_gr.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mTurq-", remove = FALSE)

pro_mTurq_ter_all_stat_phase <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mTurq_collection/pro-mTurq-ter_swaps_OD_and_mTurq.csv")) %>%
  separate(strain, into = c("Promoter", "Terminator"), sep = "-mTurq-", remove = FALSE)

norm_pro_mTurq_ter_all <- read_csv(here("raw_data_analysis/data/norm_platereader/promoter_terminator_swaps/mTurq_collection/pro-mTurq-ter_swaps_summary_PGK1_norm.csv"))
```

# Using OD to detect stationary and exponential growth phases

The gradient of the OD curve (the growth rate) is used to determine time points that represent the stationary and exponential growth phases of the samples. The time chosen to represent exponential growth is the time of maximum growth rate (largest gradient of OD curve). The time chosen to represent stationary phase is the first time point (after the half way point) where growth rate falls below 0.01. This arbitrary threshold was selected by picking a value that consistently aligned with the start of the plateau in the OD curve. Neither method is perfect, but it is consistent overall. The graph below shows the chosen stationary (dotted line) and exponential (solid line) time points across bioreps for a handful of chimera strains.

```{r selecting-stat-and-exp-times, echo=FALSE, warning=FALSE, message=FALSE}
mTurq_stat_and_exp_phase_time <- pro_mTurq_ter_all_stat_phase %>%
  filter(time > 8, gr < 0.01, !is.na(Terminator)) %>%
  group_by(experiment, Promoter, Terminator, strain) %>%
  summarise(time =min(time)) %>%
  mutate(Growth = "stat") %>%
    ungroup() %>%
  bind_rows(mTurq_stat_phase_time %>%
  filter(!is.na(Terminator)) %>%
  transmute(experiment, strain, Promoter, Terminator, time =  as.double(`time of max gr`),
            Growth = "Exp"))
  
ggplot(pro_mTurq_ter_all_stat_phase %>%
  filter(!is.na(Terminator),
  Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
  Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2"))) +
  geom_line(aes(x = time, y = `OD mean`, colour = experiment),
            show.legend = FALSE) +
  geom_vline(aes(xintercept = time, linetype = Growth), data = mTurq_stat_and_exp_phase_time %>%
               filter(Promoter %in% c("pHSP26", "pPGK1", "pRPS3", "pCLN2"),
                      Terminator %in% c("tHSP26", "tPGK1", "tRPS3", "tCLN2")),
             show.legend = FALSE) +
  facet_grid(Promoter ~ Terminator) +
  labs(title = "Selected stationary and exponential phase timepoints",
       y = "OD")
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
high_exp_pro_mTurq <- pro_mTurq_ter_protein %>%
  filter(!Promoter %in% c("pSRO9", "pCLN2"))

mTurq_stat_phase<- pro_mTurq_ter_all_stat_phase %>%
  filter(time > 8, gr < 0.01, !Promoter %in% c("null", "POT1-ccdB"), !is.na(Terminator)) %>%
  group_by(experiment, Promoter, Terminator, strain) %>%
  summarise(`fluo_per_OD_at_max_gr`=`c-mTurq-60perod`[time == min(time)]) %>%
    ungroup() %>%
  mutate(Protein = "mTurq")

norm_mTurq_stat_phase <- mTurq_stat_phase %>%
  group_by(experiment, Promoter) %>%
  mutate(`fluo_per_OD_at_max_gr` = `fluo_per_OD_at_max_gr`/`fluo_per_OD_at_max_gr`[Terminator == "tPGK1"])

ggplot(mTurq_stat_phase %>% 
         transmute(Promoter, 
                   Terminator, 
                   Strain = strain,
                   Protein,
                   fluo_per_OD_at_max_gr, 
                   Growth = "Stat") %>%
         bind_rows(high_exp_pro_mTurq %>%
                     mutate(Growth = "Exp")) %>% 
         filter(!Promoter %in% c("pSRO9", "pCLN2"),
                Protein == "mTurq")) +
  geom_vline1 + 
  geom_point(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator),
             shape = 18, size = 2) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr),
               fun="mean",colour="black",
               geom="crossbar", size=0.3, width=0.9) +
  theme(legend.position = "none",
        strip.text.x = element_text(vjust = 0.95)) +
  scale_x_continuous(oob=oob_squish, limits = c(0,NA)) +
  facet_grid(Growth~Promoter) +
  labs(x="Fluorescence per OD at max growth rate") 

```

```{r}
norm_mTurq <- norm_pro_mTurq_ter_all %>%
  rename(Protein = "mTurq", fluo_per_OD_at_max_gr = "norm_fluo_per_OD_at_max_gr") %>%
  select(-mTurq_per_OD_at_max_gr, -remove, -X1) %>%
  filter(!Promoter %in% c("pCLN2", "pSRO9")) %>%
  mutate(Terminator = factor(Terminator, ter10), Promoter = factor(Promoter, pro4))

ggplot(data=norm_mTurq_stat_phase %>% 
         transmute(Promoter, 
                   Terminator, 
                   Strain = strain,
                   Protein,
                   fluo_per_OD_at_max_gr, 
                   Growth = "Stat") %>% 
         bind_rows(norm_mTurq %>%
                     mutate(Growth = "Exp")) %>% 
         filter(!Promoter %in% c("pSRO9", "pCLN2"), 
                Protein == "mTurq")) +
  labs(x="Relative fluorescence per OD relative to tPGK1", y="Terminator") +
  facet_grid(Protein~Promoter) +
  scale_colour_hue(h = c(0, 360)+20,l=60,c=60) +
  geom_vline1 +
  stat_summary(aes(y=Terminator,x=fluo_per_OD_at_max_gr, colour = Terminator, shape = Growth),
               fun.data="mean_se",
               geom="pointrange") +
  theme(strip.text.x = element_text(vjust = 0.95)) +
  guides(colour = "none") +
  scale_x_continuous(oob=oob_squish, limits = c(0,1.9))
```
