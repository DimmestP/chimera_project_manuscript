---
title: "RT-qPCR of pRPS3-mCh-tvariable (3bioreps), pPGK1-mCh-tvariable (3bioreps) and pSRO9-mCh-tvariable (3bioreps)"
author: "Jamie Auxillos"
date: "08/01/2021"
output:
  html_document:
    toc: yes
    #toc_depth: 2
---

```{r setup,warning=FALSE,message=FALSE,echo=FALSE}

## knitr options for report generation
knitr::opts_chunk$set(warning=FALSE,message=FALSE,echo=TRUE,cache=FALSE,
                      #results="show",
                      fig.path="figures_pRPS3_pPGK1_pSRO9-tvariable/")

library(tidyverse)
library(cowplot)
library(tidyqpcr)
library(here)

 # set default theme for graphics
theme_set(theme_cowplot(font_size=11) %+replace% 
              theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
                    panel.border=element_rect(colour = "grey50",linetype = "solid",size=0.5),
                    panel.grid.major = element_line(size = 0.25, linetype = 'solid',colour = "grey"),
                    plot.title = element_text(family="Tahoma",size=11,vjust=3.3),
                    strip.background = element_blank(),
                    strip.text.x=element_text(family="Tahoma",size=9),
                    axis.text=element_text(family="Tahoma", size=10),
                    axis.title=element_text(family="Tahoma", size=10),
                    legend.text=element_text(family="Tahoma", size=8),
                    legend.title=element_text(family="Tahoma", size=9)))
```

# tPMA1 and tSRO9 variants used here are the full 3'UTR versions
```{r label_plates, echo=FALSE}

# list Targets (Primer sets)
target_id <- c("mCh-7", "URA3-ORF", "RPS3-ORF", "PGK1-ORF")
target_id_values <-factor(rep(target_id,levels=target_id))


# labelling of SampleID attributes
strain_levels_RPS3_PGK1 <- c("pRPS3-mCherry-tCLN2","pRPS3-mCherry-tHSP26","pRPS3-mCherry-tPAB1","pRPS3-mCherry-tPGK1",
                        "pRPS3-mCherry-tRPS3","pRPS3-mCherry-tRPS13","pRPS3-mCherry-tPMA1","pRPS3-mCherry-tSRO9",
                        "pRPS3-mCherry-tSUN4","pRPS3-mCherry-tTOS6","POT1-ccdB",
                        "pPGK1-mCherry-tCLN2","pPGK1-mCherry-tHSP26","pPGK1-mCherry-tPAB1","pPGK1-mCherry-tPGK1",
                        "pPGK1-mCherry-tRPS3","pPGK1-mCherry-tRPS13","pPGK1-mCherry-tPMA1","pPGK1-mCherry-tSRO9",
                        "pPGK1-mCherry-tSUN4","pPGK1-mCherry-tTOS6")
strain_levels_SRO9 <- c("pSRO9-mCherry-tCLN2","pSRO9-mCherry-tHSP26","pSRO9-mCherry-tPAB1","pSRO9-mCherry-tPGK1",
                        "pSRO9-mCherry-tRPS3","pSRO9-mCherry-tRPS13","pSRO9-mCherry-tPMA1","pSRO9-mCherry-tSRO9",
                        "pSRO9-mCherry-tSUN4","pSRO9-mCherry-tTOS6")
strain_levels_SRO9_2 <- c(rep(strain_levels_SRO9,times=2))

bio_rep_levels_1 <- c("bio_rep1")
bio_rep_levels_1_2 <- c("bio_rep1", "bio_rep2")
bio_rep_levels_2 <- c("bio_rep2")
bio_rep_levels_3 <- c("bio_rep3")
bio_rep_values_R3_P1_1 <- c(rep(bio_rep_levels_1,times=21))
bio_rep_values_R3_P1_2 <- c(rep(bio_rep_levels_2,times=21))
bio_rep_values_R3_P1_3 <- c(rep(bio_rep_levels_3,times=21))
bio_rep_values_S9_1_2 <- factor(rep(bio_rep_levels_1_2,times=10))
bio_rep_values_S9_3 <- c(rep(bio_rep_levels_3,times=10))

# Attribute labels to each row and column for each plate (pRPS3 and pPGK1 plates)
colkey_RPS3_PGK1_1 <- tibble(well_col=1:21, strain=strain_levels_RPS3_PGK1, bio_rep=bio_rep_values_R3_P1_1) 
colkey_RPS3_PGK1_2 <- tibble(well_col=1:21, strain=strain_levels_RPS3_PGK1, bio_rep=bio_rep_values_R3_P1_2) 
colkey_RPS3_PGK1_3 <- tibble(well_col=1:21, strain=strain_levels_RPS3_PGK1, bio_rep=bio_rep_values_R3_P1_3) 
colkey_SRO9_1_2 <- tibble(well_col=1:20, strain=strain_levels_SRO9_2, bio_rep=bio_rep_values_S9_1_2) 
colkey_SRO9_3 <- tibble(well_col=1:10, strain=strain_levels_SRO9, bio_rep=bio_rep_values_S9_3) 

rowkey <- create_rowkey_4_in_16(target_id=target_id_values) 


# Combine all the information into 4x plate plans
plateplan_RPS3_PGK1_1 <-     
    label_plate_rowcol(create_blank_plate(well_row = LETTERS[1:16],well_col=1:21),
                       rowkey,colkey_RPS3_PGK1_1%>% 
    unite(sample_id,strain,bio_rep,remove=FALSE)%>%
    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator")))

plateplan_RPS3_PGK1_2 <-     
    label_plate_rowcol(create_blank_plate(well_row = LETTERS[1:16],well_col=1:21),
                       rowkey,colkey_RPS3_PGK1_2%>% 
    unite(sample_id,strain,bio_rep,remove=FALSE)%>%
    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator")))

plateplan_RPS3_PGK1_3 <-     
    label_plate_rowcol(create_blank_plate(well_row = LETTERS[1:16],well_col=1:21),
                       rowkey,colkey_RPS3_PGK1_3%>% 
    unite(sample_id,strain,bio_rep,remove=FALSE)%>%
    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator")))

plateplan_SRO9_1_2 <-     
    label_plate_rowcol(create_blank_plate(well_row = LETTERS[1:16],well_col=1:20),
                       rowkey,colkey_SRO9_1_2%>% 
    unite(sample_id,strain,bio_rep,remove=FALSE)%>%
    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator")))

plateplan_SRO9_3 <-     
    label_plate_rowcol(create_blank_plate(well_row = LETTERS[1:16],well_col=1:10),
                       rowkey,colkey_SRO9_3%>% 
    unite(sample_id,strain,bio_rep,remove=FALSE)%>%
    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator")))
```

## Load data and attribute sample information
```{r load_plates,dependson="label_plates",results="show"}
# read my plates

plates_RPS3_PGK1_1 <- read_lightcycler_1colour_cq(here("./raw_data_analysis/data/raw_qpcr/promoter_terminator_swaps/JA_2020-12-12-pro-ter_pRPS3-pPGK1-n1-ct.txt"))  %>%
    left_join(plateplan_RPS3_PGK1_1)

plates_RPS3_PGK1_2 <- read_lightcycler_1colour_cq(here("./raw_data_analysis/data/raw_qpcr/promoter_terminator_swaps/JA_2020-12-13-pro-ter_pRPS3-pPGK1-n2-ct.txt"))  %>%
    left_join(plateplan_RPS3_PGK1_2)

plates_RPS3_PGK1_3 <- read_lightcycler_1colour_cq(here("./raw_data_analysis/data/raw_qpcr/promoter_terminator_swaps/JA_2020-12-14-pro-ter_pRPS3-pPGK1-n3-ct.txt"))  %>%
    left_join(plateplan_RPS3_PGK1_3)

plates_SRO9_1_2 <- read_lightcycler_1colour_cq(here("./raw_data_analysis/data/raw_qpcr/promoter_terminator_swaps/JA_2020-12-13-pro-ter_pSRO9-n1-n2-ct.txt"))  %>%
    left_join(plateplan_SRO9_1_2)

plates_SRO9_3 <- read_lightcycler_1colour_cq(here("./raw_data_analysis/data/raw_qpcr/promoter_terminator_swaps/JA_2020-12-14-pro-ter_pSRO9-n3-ct.txt"))  %>%
    left_join(plateplan_SRO9_3)

plates <- bind_rows(plates_RPS3_PGK1_1, plates_RPS3_PGK1_2, plates_RPS3_PGK1_3, plates_SRO9_1_2, plates_SRO9_3) 

summary(plates)
```


### Plotting unnormalised data for pRPS3 strains

```{r unnorm_pRPS3,fig.height=5,fig.width=10, echo=FALSE}
ggplot(data=plates %>% filter(promoter %in% c("pRPS3")), aes(x=target_id,y=cq)) +
    geom_point(aes(color=bio_rep, shape=prep_type),
               position=position_dodge(width = 0.85),size=1.6, alpha=0.7) +
    labs(y="Quantification cycle (cq)",x="Primers") +
    scale_shape_manual(values=c(16,23)) +
    scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
    facet_wrap(~strain,ncol=4) +
    theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3),
          legend.position=c(0.85,0.01))
```


### Plotting unnormalised data for pPGK1 strains

```{r unnorm_pPGK1,fig.height=5,fig.width=10, echo=FALSE}
ggplot(data=plates %>% filter(promoter %in% c("pPGK1")), aes(x=target_id,y=cq)) +
    geom_point(aes(color=bio_rep, shape=prep_type),
               position=position_dodge(width = 0.85),size=1.6, alpha=0.7) +
    labs(y="Quantification cycle (cq)",x="Primers") +
    scale_shape_manual(values=c(16,23)) +
    scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
    facet_wrap(~strain,ncol=4) +
    theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3),
          legend.position=c(0.85,0.01))
```

### Plotting unnormalised data for pSRO9 strains
```{r unnorm_pSRO9,fig.height=5,fig.width=10, echo=FALSE}
ggplot(data=plates %>% filter(promoter %in% c("pSRO9")), aes(x=target_id,y=cq)) +
    geom_point(aes(color=bio_rep, shape=prep_type),
               position=position_dodge(width = 0.85),size=1.6, alpha=0.7) +
    labs(y="Quantification cycle (cq)",x="Primers") +
    scale_shape_manual(values=c(16,23)) +
    scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
    facet_wrap(~strain,ncol=4) +
    theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3),
          legend.position=c(0.85,0.01))
```


### Plotting unnormalised data for control strains (pRPS3-mCherry-tRPS3_WT and POT1-ccdB)

```{r unnorm_POT_pRPS3, fig.height=3.5,fig.width=5.5, echo=FALSE}


ggplot(data=plates %>% filter(strain %in% c('POT1-ccdB')), aes(x=target_id,y=cq)) +
  geom_point(aes(color=bio_rep, shape=prep_type),
               position=position_dodge(width = 0.85),size=1.5, alpha=0.7) +
  labs(title="POT1-ccdB negative control stain - unnormalised Cq",y="Quantification cycle (cq)",x="Primers") +
  ylim(0,40)+
  scale_shape_manual(values=c(16,23)) +
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  facet_wrap(~strain,ncol=2)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3))
```


## Loading amplification and melt curve pRPS3 data

```{r load_amp-melt_R3,dependson="label_plates", results="show"}
platecurve_RPS3_PGK1_1 <- read_tsv(here("./raw_data_analysis/data/raw_qpcr/promoter_terminator_swaps/JA_2020-12-12-pro-ter_pRPS3-pPGK1-n1.txt"),skip=2,
                      col_names=c("well","SID","program_no","segment","cycle","time","temperature","fluor_raw")) %>%
    debaseline() %>%left_join(plateplan_RPS3_PGK1_1)%>%
    mutate(exp_rep = 1,exp_rep=factor(exp_rep))

platecurve_RPS3_PGK1_2 <- read_tsv(here("./raw_data_analysis/data/raw_qpcr/promoter_terminator_swaps/JA_2020-12-13-pro-ter_pRPS3-pPGK1-n2.txt"),skip=2,
                           col_names=c("well","SID","program_no","segment","cycle","time","temperature","fluor_raw")) %>%
    debaseline() %>%left_join(plateplan_RPS3_PGK1_2)%>%
    mutate(exp_rep = 2,exp_rep=factor(exp_rep))

platecurve_RPS3_PGK1_ <- bind_rows(platecurve_RPS3_PGK1_1, platecurve_RPS3_PGK1_2)

platesamp_RPS3_PGK1_  <- platecurve_RPS3_PGK1_ %>% filter(program_no == 2)
platesmelt_RPS3_PGK1_ <- platecurve_RPS3_PGK1_ %>% filter(program_no != 2) %>% getdRdTall() %>% filter(temperature >= 61)  
```

### Amplification Curves of POT1-ccdB strains (all bioreps) against all 4 target_ids (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pRPS3)
Here I am comparing the amplification curves of POT1-ccdB strains in pRPS3 experiments between experimental replicates (exp_rep1 in red, exp_rep2 in blue). Looking only at the mCh-7 amplification curves for each bio_rep, it seems that bio_rep1, 2 and 3 have an early cq value (reaches exponential phase at an earlier cycle) than bio_rep4, 5 and 6. However, across all amplification curves against the mCherry target, the -RT either does not have a fluorecence signal (flat dotted line) or a late cq value (fluorescence signal at a late cycle). So there doesn't seem to be a problem with samples based on the amplification curves.  

NOTE - shallow curves seems to be related to including a high cDNA volume

```{r plotamp_Rep_R3,fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesamp_RPS3 %>% filter(strain==c("POT1-ccdB")),
       aes(x=cycle,y=fluor_signal,linetype=prep_type,group=well, color=exp_rep)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of POT1-ccdB strains (bio_rep 1-6) in pRPS3 experiments") + panel_border()

ggplot(data=platesamp_RPS3 %>% filter(strain==c("pRPS3-mCherry-tRPS3_WT")),
       aes(x=cycle,y=fluor_signal,linetype=prep_type,group=well, color=exp_rep)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of pRPS3-mCherry-tRPS3_WT strains (bio_rep 1-6) in pRPS3 experiments") + panel_border()
```



### Melt Curves of POT1-ccdB and pRPS3-mCherry-tRPS3_WT strains (all bioreps) against all 4 target_ids (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pRPS3)
Here I am comparing the melt curves of POT1-ccdB and pRPS3-mCherry-tRPS3_WT strains in pRPS3 experiments between experimental replicates (exp_rep1 in red, exp_rep2 in blue).The melt curves with PGK1-ORF, RPS3-ORF and URA3-ORF probes look fine (with only 1 peak). The melt curves of the pRPS3-mCherry-tRPS3_WT show a peak at ~85C however a peak shows up at ~75C in POT1-ccdB strains which was not in the pRPS3-mCherry-tRPS3_WT strains. Apart from this, everything looks normal.  

```{r plotmelt_Rep_R3,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesmelt_RPS3 %>% filter(strain==c("POT1-ccdB")),
       aes(x=temperature,y=dRdT,group=well)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line(aes(color=exp_rep, linetype=prep_type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of POT1-ccdB strains (bio_rep 1-6) in pRPS3 experiments") + panel_border()

ggplot(data=platesmelt_RPS3 %>% filter(strain==c("pRPS3-mCherry-tRPS3_WT")),
       aes(x=temperature,y=dRdT,group=well)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line(aes(color=exp_rep, linetype=prep_type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of pRPS3-mCherry-tRPS3_WT strains (bio_rep 1-6) in pRPS3 experiments") + panel_border()
```


### Loading amplification and melt curve pPGK1 data

```{r load_amp-melt_P1,dependson="label_plates"}

platecurve_PGK1_1 <- read_tsv(here("raw_data_analysis/data/raw_qpcr/motif_context_dependence/pPGK1-tRPS3/JA_20200221_pPGK1-tRPS3mod-n1.txt"),skip=2,
                           col_names=c("well","SID","program_no","segment","cycle","time","temperature","fluor_raw")) %>%
    debaseline() %>%left_join(plateplan_PGK1_1)%>%
    mutate(exp_rep = 1,exp_rep=factor(exp_rep))

platecurve_PGK1_2 <- read_tsv(here("raw_data_analysis/data/raw_qpcr/motif_context_dependence/pPGK1-tRPS3/JA_20200311-pPGK1-tRPS3mod-n2.txt"),skip=2,
                           col_names=c("well","SID","program_no","segment","cycle","time","temperature","fluor_raw")) %>%
    debaseline() %>%left_join(plateplan_PGK1_2)%>%
    mutate(exp_rep = 2,exp_rep=factor(exp_rep))

platecurve_PGK1 <- bind_rows(platecurve_PGK1_1, platecurve_PGK1_2)

platesamp_PGK1  <- platecurve_PGK1 %>% filter(program_no == 2)
platesmelt_PGK1 <- platecurve_PGK1 %>% filter(program_no != 2) %>% getdRdTall() %>% filter(temperature >= 61)  
```

### Amplification Curves of POT1-ccdB strains (all bioreps) against all 4 target_ids (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pPGK1)
Here I am comparing the amplification curves of POT1-ccdB strains in pRPS3 experiments between experimental replicates (exp_rep1 in red, exp_rep2 in blue). Looking only at the mCh-7 amplification curves for each bio_rep, it seems that bio_rep1, 2 and 3 have an early cq value (reaches exponential phase at an earlier cycle) than bio_rep4, 5 and 6. However, across all amplification curves against the mCherry target, the -RT either does not have a fluorecence signal (flat dotted line) or a late cq value (fluorescence signal at a late cycle). So there doesn't seem to be a problem with samples based on the amplification curves.  

NOTE - shallow curves seems to be related to including a high cDNA volume (seemed to clear up when I added more RNA to cDNA reaction then used less of the reaction for qPCR)

```{r plotamp_Rep_PGK1,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesamp_PGK1 %>% filter(strain==c("POT1-ccdB")),
       aes(x=cycle,y=fluor_signal,linetype=prep_type,group=well, color=exp_rep)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of POT1-ccdB strains (bio_rep 1-6) in pPGK1 experiments") + panel_border()
```

### Melt Curves of POT1-ccdB and pPGK1-mCherry-tRPS3_WT strains (all bioreps) against all 4 target_ids (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pPGK1)
Here I am comparing the melt curves of POT1-ccdB and pRPS3-mCherry-tRPS3_WT strains in pRPS3 experiments between experimental replicates (exp_rep1 in red, exp_rep2 in blue).The melt curves with PGK1-ORF, RPS3-ORF and URA3-ORF probes look fine (with only 1 peak). The melt curves of the pRPS3-mCherry-tRPS3_WT show a peak at ~85C however a peak shows up at ~75C in POT1-ccdB strains which was not in the pRPS3-mCherry-tRPS3_WT strains. Apart from this, everything looks normal.  

```{r plotmelt_Rep_PGK1,fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesmelt_PGK1 %>% filter(strain==c("POT1-ccdB")),
       aes(x=temperature,y=dRdT,group=well)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line(aes(color=exp_rep, linetype=prep_type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of POT1-ccdB strains (bio_rep 1-6) in pPGK1 experiments") + panel_border()

ggplot(data=platesmelt_PGK1 %>% filter(strain==c("pPGK1-mCherry-tRPS3_WT")),
       aes(x=temperature,y=dRdT,group=well)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line(aes(color=exp_rep, linetype=prep_type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of pPGK1-mCherry-tRPS3_WT strains (bio_rep 1-6) in pPGK1 experiments") + panel_border()
```

### Loading amplification and melt curve pSRO9 data

```{r load_amp-melt_SRO9,dependson="label_plates"}

platecurve_SRO9_1 <- read_tsv(here("raw_data_analysis/data/raw_qpcr/motif_context_dependence/pSRO9-tRPS3/JA_20200814-pSRO9-tRPS3mod-n1.txt"),skip=2,
                           col_names=c("well","SID","program_no","segment","cycle","time","temperature","fluor_raw")) %>%
    debaseline() %>%left_join(plateplan_SRO9_1)%>%
    mutate(exp_rep = 1,exp_rep=factor(exp_rep))

platecurve_SRO9_2 <- read_tsv(here("raw_data_analysis/data/raw_qpcr/motif_context_dependence/pSRO9-tRPS3/JA_20200924-pSRO9-tRPS3mod_n2.txt"),skip=2,
                           col_names=c("well","SID","program_no","segment","cycle","time","temperature","fluor_raw")) %>%
    debaseline() %>%left_join(plateplan_SRO9_2)%>%
    mutate(exp_rep = 2,exp_rep=factor(exp_rep))

platecurve_SRO9 <- bind_rows(platecurve_SRO9_1, platecurve_SRO9_2)

platesamp_SRO9  <- platecurve_SRO9 %>% filter(program_no == 2)
platesmelt_SRO9 <- platecurve_SRO9 %>% filter(program_no != 2) %>% getdRdTall() %>% filter(temperature >= 61)  
```

### Amplification Curves of POT1-ccdB strains (all bioreps) against all 4 target_ids (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pSRO9)


```{r plotamp_Rep_SRO9,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesamp_SRO9 %>% filter(strain==c("POT1-ccdB")),
       aes(x=cycle,y=fluor_signal,linetype=prep_type,group=well, color=exp_rep)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of POT1-ccdB strains (bio_rep 1-6) in pSRO9 experiments") + panel_border()
```

### Melt Curves of POT1-ccdB and pPGK1-mCherry-tRPS3_WT strains (all bioreps) against all 4 target_ids (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (SRO9)

```{r plotmelt_Rep_SRO9,fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesmelt_SRO9 %>% filter(strain==c("POT1-ccdB")),
       aes(x=temperature,y=dRdT,group=well)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line(aes(color=exp_rep, linetype=prep_type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of POT1-ccdB strains (bio_rep 1-6) in pSRO9 experiments") + panel_border()

ggplot(data=platesmelt_SRO9 %>% filter(strain==c("pSRO9-mCherry-tRPS3_WT")),
       aes(x=temperature,y=dRdT,group=well)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line(aes(color=exp_rep, linetype=prep_type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of pSRO9-mCherry-tRPS3_WT strains (bio_rep 1-6) in pSRO9 experiments") + panel_border()
```


## 1) Delta cq calculation
norm_function changed to **mean**

```{r deltacq_norm, echo=TRUE, fig.height=6, fig.width=9}

# platesnorm first excludes pPGK1-mCherry-tRPS3_WT_bio_rep2, and all POT1-ccdB strains, then takes all +RT results, then normalises the cq values by the median of normtarget_ids, then filters cq values for mCh-7
platesnorm <- plates  %>% 
        filter(!strain %in% c("POT1-ccdB"), prep_type=="+RT") %>%    
        calculate_deltacq_bysampleid(ref_target_ids = c("PGK1-ORF", "RPS3-ORF", "URA3-ORF"), norm_function = mean)

platesnorm_summarise <- platesnorm%>%
                    group_by(strain, target_id, bio_rep)%>%
                    summarize(deltacq = median(delta_cq, na.rm=TRUE),
                              rel_abund_deltacq = (2^-deltacq), na.rm=FALSE)%>% 
    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator"))



ggplot(platesnorm, aes(terminator,delta_cq))+
  geom_point(aes(color=bio_rep, shape=promoter),position=position_dodge(width = 0.85),size=1.2, alpha=0.7)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  labs(y="delta cq", x="3'UTR-terminators")+
  facet_wrap(~target_id)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 
```

### 1) Exporting analysed delta cq values data
#```{r deltacq_normdata, echo=TRUE}
#exporting platesnorm dataframe
#write.csv(platesnorm_summarise,here("raw_data_analysis/data/norm_qpcr/motif_context_dependence/pRPS3_pPGK1_pSRO9_tRPS3_deltacq_platesnorm_summarise.csv"), row.names = FALSE)

#```

Plot shows shifted distributions in normalised cq values for pRPS3 samples between experimental replciates. This shift in distributions between experimental replicates is not seen for pPGK1 samples.
```{r plot_deltacq, echo=TRUE, fig.height=5, fig.width=9}

ggplot(platesnorm %>% filter(target_id %in% 'mCh-7'), aes(terminator,delta_cq))+
  geom_point(aes(color=bio_rep),position=position_dodge(width = 0.85),size=1.2, alpha=1)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  labs(y="delta cq", x="3'UTR-terminators")+
  facet_wrap(~promoter)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 
```

## 2) Delta-delta cq and RNA abundance calculation (one mod0 mean per exp_rep per promoter)

```{r delta-deltacq_norm_RPS3_exp_rep, echo=TRUE}

# Extracts the pRPS3 strains
platesnorm_pRPS3_bio_rep <- platesnorm %>% filter(promoter %in% "pRPS3", target_id %in% "mCh-7")
  
# Calculates the mean cq value of pRPS3-mCherry-tPGK1 Samples
mean_platesnorm_pRPS3_P1_bio_rep1 <- platesnorm_pRPS3_bio_rep  %>% filter(bio_rep %in% c('bio_rep1'))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pRPS3-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))

# Calculates the mean cq value of pRPS3-mCherry-tPGK1 Samples
mean_platesnorm_pRPS3_P1_bio_rep2 <- platesnorm_pRPS3_bio_rep  %>% filter(bio_rep %in% c('bio_rep2'))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pRPS3-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))

# Calculates the mean cq value of pRPS3-mCherry-tPGK1 Samples
mean_platesnorm_pRPS3_P1_bio_rep3 <- platesnorm_pRPS3_bio_rep  %>% filter(bio_rep %in% c('bio_rep3'))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pRPS3-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))

# Calculates the delta delta cq (subtracts mean(pRPS3_P1$delta_cq) from every delta_cq))
platesnorm_P1_pRPS3_bio_rep1 <- platesnorm_pRPS3_bio_rep %>% filter(bio_rep %in% c('bio_rep1'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pRPS3_P1_bio_rep1$mean_P1, remove=FALSE)
platesnorm_P1_pRPS3_bio_rep2 <- platesnorm_pRPS3_bio_rep %>% filter(bio_rep %in% c('bio_rep2'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pRPS3_P1_bio_rep2$mean_P1, remove=FALSE)
platesnorm_P1_pRPS3_bio_rep3 <- platesnorm_pRPS3_bio_rep %>% filter(bio_rep %in% c('bio_rep3'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pRPS3_P1_bio_rep2$mean_P1, remove=FALSE)
```


```{r delta-deltacq_norm_PGK1_exp_rep, echo=TRUE}
# Extracts the pPGK1 strains
platesnorm_pPGK1_bio_rep <- platesnorm %>% filter(promoter %in% "pPGK1", target_id %in% "mCh-7")
  
# Calculates the mean cq value of pPGK1-mCherry-tPGK1 Samples
mean_platesnorm_pPGK1_P1_bio_rep1 <- platesnorm_pPGK1_bio_rep  %>% filter(bio_rep %in% c('bio_rep1'))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pPGK1-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))

# Calculates the mean cq value of pPGK1-mCherry-tPGK1 Samples
mean_platesnorm_pPGK1_P1_bio_rep2 <- platesnorm_pPGK1_bio_rep  %>% filter(bio_rep %in% c('bio_rep2'))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pPGK1-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))

# Calculates the mean cq value of pPGK1-mCherry-tPGK1 Samples
mean_platesnorm_pPGK1_P1_bio_rep3 <- platesnorm_pPGK1_bio_rep  %>% filter(bio_rep %in% c('bio_rep3'))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pPGK1-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))

# Calculates the delta delta cq (subtracts mean(pPGK1_P1$delta_cq) from every delta_cq))
platesnorm_P1_pPGK1_bio_rep1 <- platesnorm_pPGK1_bio_rep %>% filter(bio_rep %in% c('bio_rep1'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pPGK1_P1_bio_rep1$mean_P1, remove=FALSE)
platesnorm_P1_pPGK1_bio_rep2 <- platesnorm_pPGK1_bio_rep %>% filter(bio_rep %in% c('bio_rep2'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pPGK1_P1_bio_rep2$mean_P1, remove=FALSE)
platesnorm_P1_pPGK1_bio_rep3 <- platesnorm_pPGK1_bio_rep %>% filter(bio_rep %in% c('bio_rep3'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pPGK1_P1_bio_rep2$mean_P1, remove=FALSE)
```

```{r delta-deltacq_norm_SRO9_exp_rep, echo=TRUE}
# Extracts the pSRO9 strains
platesnorm_pSRO9_bio_rep <- platesnorm %>% filter(promoter %in% "pSRO9", target_id %in% "mCh-7")
  
# Calculates the mean cq value of pSRO9-mCherry-tPGK1 Samples
mean_platesnorm_pSRO9_P1_bio_rep1 <- platesnorm_pSRO9_bio_rep %>% filter(sample_id %in% c("pSRO9-mCherry-tPGK1_bio_rep1"))
  
  platesnorm_pSRO9_bio_rep  %>% filter(bio_rep %in% c('bio_rep1'), strain %in% c("pSRO9-mCherry-tPGK1"))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pSRO9-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))




# Calculates the mean cq value of pSRO9-mCherry-tPGK1 Samples
mean_platesnorm_pSRO9_P1_bio_rep2 <- platesnorm_pSRO9_bio_rep  %>% filter(bio_rep %in% c('bio_rep2'))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pSRO9-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))

# Calculates the mean cq value of pSRO9-mCherry-tPGK1 Samples
mean_platesnorm_pSRO9_P1_bio_rep3 <- platesnorm_pSRO9_bio_rep  %>% filter(bio_rep %in% c('bio_rep3'))%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pSRO9-mCherry-tPGK1")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_P1 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_P1 = mean(median_bio_rep_P1))

# Calculates the delta delta cq (subtracts mean(pSRO9_P1$delta_cq) from every delta_cq))
platesnorm_P1_pSRO9_bio_rep1 <- platesnorm_pSRO9_bio_rep %>% filter(bio_rep %in% c('bio_rep1'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pSRO9_P1_bio_rep1$mean_P1, remove=FALSE)
platesnorm_P1_pSRO9_bio_rep2 <- platesnorm_pSRO9_bio_rep %>% filter(bio_rep %in% c('bio_rep2'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pSRO9_P1_bio_rep2$mean_P1, remove=FALSE)
platesnorm_P1_pSRO9_bio_rep3 <- platesnorm_pSRO9_bio_rep %>% filter(bio_rep %in% c('bio_rep3'))%>%
    mutate(delta_cq.P1 = delta_cq - mean_platesnorm_pSRO9_P1_bio_rep2$mean_P1, remove=FALSE)
```

## 2) Mean delta delta cq and RNA abundance calculation
In the previous 2 chunks, we have calculated the delta-delta cq value for each techrep. Here, we are summarising that information by calculating the median cq for each biorep and calculating the RNA abundance (2^-Median_cq).  

```{r mean_rna_abund_exp_rep, echo=TRUE}

# Combining the calculated delta-delta cq from the two dataframes then calculating the Median delta-delta cq. RNA abundance is calculated by the following formula 2^(- Median_cq). 
platesnorm_P1_median_bio_rep <- bind_rows(platesnorm_P1_pRPS3_bio_rep1, platesnorm_P1_pRPS3_bio_rep2, platesnorm_P1_pRPS3_bio_rep3,
                                            platesnorm_P1_pPGK1_bio_rep1, platesnorm_P1_pPGK1_bio_rep2, platesnorm_P1_pPGK1_bio_rep3)%>%
                    group_by(strain, target_id, bio_rep)%>%
                    summarize(delta_deltacq = median(delta_cq.P1, na.rm=TRUE),
                              rel_abund_delta_deltacq = (2^-delta_deltacq), na.rm=FALSE)%>%
                    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator"))
```

### 2) Plotting the results in a scatter plot

```{r plot_delta_deltacq_exp_rep_1,fig.height=2,fig.width=5, echo=FALSE}

normalised_plot_bio_rep_R3 <- ggplot(data = platesnorm_P1_median_bio_rep %>% filter(promoter %in% c('pRPS3')))+
    geom_point(aes(terminator,rel_abund_delta_deltacq, colour=terminator, shape=bio_rep)) +
    #scale_x_log2nice(name="Fold change in RNA abundance relative to tRPS3-mod0 (log2 scale)",omag = seq(-5,5),scilabels=TRUE) +
    scale_y_log2nice(name="Fold change in RNA abundance of pRPS3 relative to \n pRPS3-mCherry-tPGK1 (log2 scale)",omag = seq(-5,5),scilabels=FALSE) +
      labs(y="") +
    #scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    #scale_colour_manual(values=c( "grey50", "#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black")) +
    guides(colour=FALSE) +
    theme(axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          legend.position="bottom",
          legend.box.margin=margin(20,10,10,180))
#axis.text.y=element_text(colour=c("grey50", "#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black"))
  #facet_wrap(~promoter))

normalised_plot_bio_rep_R3 + stat_summary(aes(terminator, rel_abund_delta_deltacq),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 

normalised_plot_bio_rep_P1 <- ggplot(data = platesnorm_P1_median_bio_rep %>% filter(promoter %in% c('pPGK1')))+
    geom_point(aes(terminator,rel_abund_delta_deltacq, colour=terminator, shape=bio_rep)) +
    #scale_x_log2nice(name="Fold change in RNA abundance relative to tRPS3-mod0 (log2 scale)",omag = seq(-5,5),scilabels=TRUE) +
    scale_y_log2nice(name="Fold change in RNA abundance of pPGK1 relative to \n pPGK1-mCherry-tPGK1 (log2 scale)",omag = seq(-5,5),scilabels=FALSE) +
      labs(y="") +
    #scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    #scale_colour_manual(values=c( "grey50", "#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black")) +
    guides(colour=FALSE) +
    theme(axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          legend.position="bottom",
          legend.box.margin=margin(20,10,10,180))
#axis.text.y=element_text(colour=c("grey50", "#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black"))
  #facet_wrap(~promoter))

normalised_plot_bio_rep_P1 + stat_summary(aes(terminator, rel_abund_delta_deltacq),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 
```

```{r plot_delta_deltacq_exp_rep_2,fig.height=9,fig.width=5, echo=FALSE}

normalised_plot1_exp_rep <- ggplot(data = platesnorm_P1_median_bio_rep)+
    geom_point(aes(rel_abund_delta_deltacq,terminator,colour=terminator, shape=bio_rep)) +
    scale_x_log2nice(name="Fold change in RNA abundance relative to tRPS3-mod0 \n (log2 scale)",omag = seq(-5,5),scilabels=FALSE) +
    labs(y="") +
    #scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    #scale_colour_manual(values=c("#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black")) +
    guides(colour=FALSE) +
    theme(axis.text.y=element_text(colour=c("#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black")),
          axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(size=10,vjust=-2),
          legend.position="bottom",
          legend.box.margin=margin(20,0,0,30))+
    facet_wrap(~promoter,nrow = 3)

normalised_plot1_exp_rep + stat_summary(aes(rel_abund_delta_deltacq,terminator),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 
```
