---
title: "RT-qPCR of pSRO9-mCh-tRPS3mod (2 reps)"
author: "Jamie Auxillos"
date: "21/09/2020"
output:
  html_document:
    toc: yes
    #toc_depth: 2
---

```{r setup,warning=FALSE,message=FALSE,echo=FALSE}

## knitr options for report generation
knitr::opts_chunk$set(warning=FALSE,message=FALSE,echo=TRUE,cache=FALSE,
                      #results="show",
                      fig.path="figures_tRPS3mod_dataanalysis/")

library(tidyverse)
library(cowplot)
library(tidyqpcr)

 # set default theme for graphics
theme_set(theme_cowplot(font_size=11) %+replace% 
              theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
                    panel.border=element_rect(colour = "grey50",linetype = "solid",size=0.5),
                    panel.grid.major = element_line(size = 0.25, linetype = 'solid',colour = "grey"),
                    plot.title = element_text(family="Tahoma",size=11,vjust=3.3),
                    strip.background = element_blank(),
                    strip.text.x=element_text(family="Tahoma",size=9),
                    axis.text=element_text(family="Tahoma", size=10),
                    axis.title=element_text(family="Tahoma", size=10),
                    legend.text=element_text(family="Tahoma", size=8),
                    legend.title=element_text(family="Tahoma", size=9)))
```

```{r label_plates,dependson="plate_functions", echo=FALSE}

# list Targets (Primer sets)
TargetID <- c("mCh-7", "URA3-ORF", "RPS3-ORF", "PGK1-ORF")
TargetIDvalues <-factor(rep(TargetID,levels=TargetID))


# labelling of SampleID attributes
StrainlevelsS9 <- c("pSRO9-mCherry-tRPS3_WT","pSRO9-mCherry-tRPS3_mod0","pSRO9-mCherry-tRPS3_modA","pSRO9-mCherry-tRPS3_modB","pSRO9-mCherry-tRPS3_modC", "pSRO9-mCherry-tRPS3_modD", "pSRO9-mCherry-tRPS3_modE","POT1-ccdB")
StrainvaluesS9 <- factor(rep(StrainlevelsS9,each=3),levels=StrainlevelsS9)
BioReplevels_A <- c("BioRep1","BioRep2","BioRep3")
BioRepvalues_A <- factor(rep(BioReplevels_A,times=8),levels=BioReplevels_A)
BioReplevels_B <- c("BioRep4","BioRep5","BioRep6")
BioRepvalues_B <- factor(rep(BioReplevels_B,times=8),levels=BioReplevels_B)

# Attribute labels to each row and column for each plate (pSRO9 and pPGK1 plates)
colkeyS9_1 <- tibble(WellC=1:24, Strain=StrainvaluesS9, BioRep=BioRepvalues_A) 
colkeyS9_2 <- tibble(WellC=1:24, Strain=StrainvaluesS9, BioRep=BioRepvalues_B) 
rowkey <- create_rowkey_4in16(TargetID=TargetIDvalues) 


# Combine all the information into 4x plate plans
plateplanS9_1 <-     
    label_plate_rowcol(create_blank_plate(WellR = LETTERS[1:16],WellC=1:24),
                       rowkey,colkeyS9_1%>% 
    unite(SampleID,Strain,BioRep,remove=FALSE)%>%
    separate(Strain, remove = FALSE,sep="-",into=c("Promoter","mCherry","Terminator")) %>%
    separate(Terminator, remove = FALSE, sep="_",into=c("Terminator","Construct")) %>%
    mutate(Construct = factor(Construct,levels = c("modE","modD","modC","modB","modA","mod0","WT")),remove = FALSE)%>%
    unite(Pro_mCh,Promoter,mCherry,sep="-", remove=FALSE)%>%
    unite(Ter_mod,Terminator,Construct,sep="_", remove=FALSE))

plateplanS9_2 <-     
    label_plate_rowcol(create_blank_plate(WellR = LETTERS[1:16],WellC=1:24),
                       rowkey,colkeyS9_2%>% 
    unite(SampleID,Strain,BioRep,remove=FALSE)%>%
    separate(Strain, remove = FALSE,sep="-",into=c("Promoter","mCherry","Terminator")) %>%
    separate(Terminator, remove = FALSE, sep="_",into=c("Terminator","Construct")) %>%
    mutate(Construct = factor(Construct,levels = c("modE","modD","modC","modB","modA","mod0","WT")),remove = FALSE)%>%
    unite(Pro_mCh,Promoter,mCherry,sep="-", remove=FALSE)%>%
    unite(Ter_mod,Terminator,Construct,sep="_", remove=FALSE))

```

## Load data and attribute sample information
```{r load_plates,dependson="label_plates",results="show"}
# read my plates
platesS9_1 <- read_tsv("data/JA_20200814-pSRO9-tRPS3mod-n1-ct.txt",skip=1) %>%
    mutate(Well=Pos,Cq=Cp,ExpRep = 1,ExpRep=factor(ExpRep)) %>%
    left_join(plateplanS9_1)


platesS9_2 <- read_tsv("data/JA_20200830-pSRO9-tRPS3mod-n2-ct.txt",skip=1) %>%
    mutate(Well=Pos,Cq=Cp,ExpRep = 2,ExpRep=factor(ExpRep)) %>%
    left_join(plateplanS9_2)

plates <- bind_rows(platesS9_1, platesS9_2)

summary(plates)
```


### Plotting unnormalised data for pSRO9 strains
```{r unnorm_pSRO9,dependson="load_plates",fig.height=5,fig.width=10, echo=FALSE}
platespSRO9 <- plates%>% filter(Strain %in% c("pSRO9-mCherry-tRPS3_WT","pSRO9-mCherry-tRPS3_mod0","pSRO9-mCherry-tRPS3_modA","pSRO9-mCherry-tRPS3_modB",
                                           "pSRO9-mCherry-tRPS3_modC","pSRO9-mCherry-tRPS3_modD","pSRO9-mCherry-tRPS3_modE"))%>%
  mutate(Strain = factor(Strain,levels=c("pSRO9-mCherry-tRPS3_WT","pSRO9-mCherry-tRPS3_mod0","pSRO9-mCherry-tRPS3_modA","pSRO9-mCherry-tRPS3_modB",
                                           "pSRO9-mCherry-tRPS3_modC","pSRO9-mCherry-tRPS3_modD","pSRO9-mCherry-tRPS3_modE")))

ggplot(data=platespSRO9, aes(x=TargetID,y=Cq)) +
    geom_point(aes(color=BioRep, shape=Type),
               position=position_dodge(width = 0.85),size=1.6, alpha=0.7) +
    labs(y="Quantification cycle (Cq)",x="Primers") +
    scale_shape_manual(values=c(16,23)) +
    scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
    facet_wrap(~Strain,ncol=4) +
    theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3),
          legend.position=c(0.85,0.01))
```


### Plotting unnormalised data for control strains (pSRO9-mCherry-tRPS3_WT and POT1-ccdB)

```{r unnorm_POT_pSRO9, fig.height=3.5,fig.width=5.5, echo=FALSE}

platesPOT_RPS3 <- plates%>% filter(Strain %in% c("pSRO9-mCherry-tRPS3_WT","POT1-ccdB"))

ggplot(data=platesPOT_RPS3, aes(x=TargetID,y=Cq)) +
  geom_point(aes(color=BioRep, shape=Type),
               position=position_dodge(width = 0.85),size=1.5, alpha=0.7) +
  labs(title="Controls for pSRO9 strains - \n Comparing between experimental replicates",y="Quantification cycle (Cq)",x="Primers") +
  ylim(0,40)+
  scale_shape_manual(values=c(16,23)) +
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  facet_wrap(~Strain,ncol=2)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3))
```


## Loading amplification and melt curve pSRO9 data

```{r load_amp-melt_S9,dependson="label_plates", results="show"}

platecurveS9_1 <- read_tsv("data/JA_20200814-pSRO9-tRPS3mod-n1.txt",skip=2,
                           col_names=c("Well","SID","Program","Segment","Cycle","Time","Temperature","Fluor")) %>%
    debaseline() %>%left_join(plateplanS9_1)%>%
    mutate(ExpRep = 1,ExpRep=factor(ExpRep))

platecurveS9_2 <- read_tsv("data/JA_20200830-pSRO9-tRPS3mod-n2.txt",skip=2,
                           col_names=c("Well","SID","Program","Segment","Cycle","Time","Temperature","Fluor")) %>%
    debaseline() %>%left_join(plateplanS9_2)%>%
    mutate(ExpRep = 2,ExpRep=factor(ExpRep))

platecurveS9 <- bind_rows(platecurveS9_1, platecurveS9_2)

platesampS9  <- platecurveS9 %>% filter(Program == 2)
platesmeltS9 <- platecurveS9 %>% filter(Program != 2) %>% getdRdTall() %>% filter(Temperature >= 61)  
head(platesampS9)
head(platesmeltS9)
```

### Amplification Curves of POT1-ccdB strains (all bioreps) against all 4 TargetIDs (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pSRO9)

```{r plotamp_Rep1_S9,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesampS9 %>% filter(Strain==c("POT1-ccdB")),
       aes(x=Cycle,y=Signal,linetype=Type,group=Well, color=ExpRep)) + 
    facet_grid(BioRep~TargetID) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of POT1-ccdB strains (BioRep 1-6) in pSRO9 experiments") + panel_border()

ggplot(data=platesampS9 %>% filter(Strain==c("pSRO9-mCherry-tRPS3_WT")),
       aes(x=Cycle,y=Signal,linetype=Type,group=Well, color=ExpRep)) + 
    facet_grid(BioRep~TargetID) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of pSRO9-mCherry-tRPS3_WT strains (BioRep 1-6) in pSRO9 experiments") + panel_border()
```


### Melt Curves of POT1-ccdB and pSRO9-mCherry-tRPS3_WT strains (all bioreps) against all 4 TargetIDs (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pSRO9)

```{r plotmelt_Rep1_S9,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesmeltS9 %>% filter(Strain==c("POT1-ccdB")),
       aes(x=Temperature,y=dRdT,group=Well)) + 
    facet_grid(BioRep~TargetID) + 
    geom_line(aes(color=ExpRep, linetype=Type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of POT1-ccdB strains (BioRep 1-6) in pSRO9 experiments") + panel_border()

ggplot(data=platesmeltS9 %>% filter(Strain==c("pSRO9-mCherry-tRPS3_WT")),
       aes(x=Temperature,y=dRdT,group=Well)) + 
    facet_grid(BioRep~TargetID) + 
    geom_line(aes(color=ExpRep, linetype=Type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of pSRO9-mCherry-tRPS3_WT strains (BioRep 1-6) in pSRO9 experiments") + panel_border()
```


## 1) Delta Cq calculation
Normalisation of mCherry Cq values against PGK1-ORF, URA3-ORF and RPS3-ORF Cq values. This calculation takes the **median** of normTargetIDs (getNormCq function default is **median**)

```{r deltaCq_norm,dependson="load_plates", echo=TRUE, fig.height=6, fig.width=9}

getNormCq <- function(cq_df,value="Cq",normTargetIDs="ALG9",probename="TargetID",
                      normby.function=mean) {
    # make subset of cq_df where gene is one of normTargetIDs
    norm.by <- dplyr::filter(cq_df, !!dplyr::sym(probename) %in% normTargetIDs) %>%
        .[[value]] %>%
        normby.function(na.rm=TRUE)
    # assign mean of value to cq_df$norm.by
    # note this is the same value for every row, a waste of space technically
    cq_df %>%
        dplyr::mutate(norm.by = norm.by) %>%
        return()}

# platesnorm first excludes pPGK1-mCherry-tRPS3_WT_BioRep2, and all POT1-ccdB strains, then takes all +RT results, then normalises the Cq values by the median of normTargetIDs, then filters Cq values for mCh-7
platesnorm <- plates  %>% 
        filter(!Strain %in% c("POT1-ccdB"), Type=="+RT") %>%    
        normalizeqPCR(normTargetIDs = c("PGK1-ORF","RPS3-ORF","URA3-ORF")) 

# to verify the calculation done 
platesnorm %>% select(Strain, BioRep, TechRep, Value.norm, Value.normexp)

ggplot(platesnorm, aes(Ter_mod,Value.norm))+
  geom_point(aes(color=BioRep),position=position_dodge(width = 0.85),size=1.2, alpha=0.7)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  labs(y="delta Cq", x="3'UTR-terminators")+
  facet_wrap(~TargetID)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 

ggplot(platesnorm %>% filter(Promoter %in% c("pSRO9")), aes(Ter_mod,Value.norm))+
  geom_point(aes(color=BioRep),position=position_dodge(width = 0.8),size=1.5, alpha=0.7)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  ylim(-6,6)+
  labs(y="delta Cq", x="3'UTR-terminators")+
  facet_wrap(~TargetID)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 

```

Plot shows shifted distributions in normalised Cq values for pSRO9 samples between experimental replciates. This shift in distributions between experimental replicates is not seen for pPGK1 samples.
```{r deltaCq_norm_1,dependson="load_plates", echo=TRUE, fig.height=5, fig.width=9}

ggplot(platesnorm %>% filter(TargetID %in% 'mCh-7'), aes(Ter_mod,Value.norm))+
  geom_point(aes(color=BioRep),position=position_dodge(width = 0.85),size=1.2, alpha=1)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  labs(y="delta Cq", x="3'UTR-terminators")+
  facet_wrap(~Promoter)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 
```

## 2A) Delta-delta Cq and RNA abundance calculation (one mod0 mean per ExpRep per promoter)
Normalisation of delta Cq values against tRPS3-mod0 delta Cq values. Strains are first subdivided based on their promoter (either pPGK1 or pSRO9).   

pSRO9-mCherry-tRPS3_mod0 datapoints were divided into two based on ExpRep. From this, two (depending on ExpRep) **Mean Value.norm of pSRO9-mCherry-tRPS3_mod0** were calculated by taking the median Value.norm among TechReps of each BioRep (of pSRO9-mCherry-tRPS3_mod0), then calculating **two** mean Value.norm among BioReps of pSRO9-mCherry-tRPS3_mod0 for each ExpRep. 

pSRO9 datapoints were subdivided based on ExpRep. Delta delta Cq is calculated by subtracting the **Mean Value.norm of pSRO9-mCherry-tRPS3_mod0 of ExpRep1** from each Value.norm of all other strains in ExpRep1. Delta delta Cq is calculated by subtracting the **Mean Value.norm of pSRO9-mCherry-tRPS3_mod0 of ExpRep2** from each Value.norm of all other strains in ExpRep2. (NOTE - we still have one Value.norm for each TechRep and BioRep here). 

**NOTE - Here median is used to summarise/collapse TechReps and mean is used to summarise/collapse BioReps**
```{r delta-deltaCq_norm_RPS3_ExpRep, echo=TRUE}

# Extracts the pSRO9 strains
platesnorm_pSRO9_ExpRep <- platesnorm %>% filter(Promoter %in% "pSRO9", TargetID %in% "mCh-7")
  
# Calculates the mean Cq value of pSRO9-mCherry-tRPS3_mod0 Samples (-0.3833333	)
mean_platesnorm_pSRO9mod0_ExpRep1 <- platesnorm_pSRO9_ExpRep  %>% filter(ExpRep==1)%>%
    select(c("Strain","Value.norm", "BioRep", "TechRep")) %>% 
    filter(Strain %in% c("pSRO9-mCherry-tRPS3_mod0")) %>%
    group_by(Strain, BioRep)%>%
    summarize(median_BioRep_pSRO9mod0 = median(Value.norm)) %>%
    ungroup()%>%
    group_by(Strain)%>%
    summarize(mean_pSRO9mod0 = mean(median_BioRep_pSRO9mod0))

# Calculates the mean Cq value of pSRO9-mCherry-tRPS3_mod0 Samples (-1.346667	)
mean_platesnorm_pSRO9mod0_ExpRep2 <- platesnorm_pSRO9_ExpRep  %>% filter(ExpRep==2)%>%
    select(c("Strain","Value.norm", "BioRep", "TechRep")) %>% 
    filter(Strain %in% c("pSRO9-mCherry-tRPS3_mod0")) %>%
    group_by(Strain, BioRep)%>%
    summarize(median_BioRep_pSRO9mod0 = median(Value.norm)) %>%
    ungroup()%>%
    group_by(Strain)%>%
    summarize(mean_pSRO9mod0 = mean(median_BioRep_pSRO9mod0))

# Calculates the delta delta Cq (subtracts mean(pSRO9mod0$Value.norm) from every Value.norm))
platesnorm_mod0_pSRO9_ExpRep1 <- platesnorm_pSRO9_ExpRep %>% filter(ExpRep==1)%>%
    mutate(Value.norm.mod0 = Value.norm - mean_platesnorm_pSRO9mod0_ExpRep1$mean_pSRO9mod0, remove=FALSE)
platesnorm_mod0_pSRO9_ExpRep2 <- platesnorm_pSRO9_ExpRep %>% filter(ExpRep==2)%>%
    mutate(Value.norm.mod0 = Value.norm - mean_platesnorm_pSRO9mod0_ExpRep2$mean_pSRO9mod0, remove=FALSE)

# to verify the calculation done 
platesnorm_mod0_pSRO9_ExpRep1 %>% select(Strain, BioRep, TechRep, Value.norm.mod0)
```

## 2B) Mean Cq and RNA abundance calculation
In the previous 2 chunks, we have calculated the delta-delta Cq value for each techrep. Here, we are summarising that information by calculating the median Cq for each biorep and calculating the RNA abundance (2^-Median_Cq).  

```{r mean_rna_abund_ExpRep, echo=TRUE}

# Combining the calculated delta-delta Cq from the two dataframes then calculating the Median delta-delta Cq. RNA abundance is calculated by the following formula 2^(- Median_Cq). 
platesnorm_mod0_median_ExpRep <- bind_rows(platesnorm_mod0_pSRO9_ExpRep1, platesnorm_mod0_pSRO9_ExpRep2)%>%
                    group_by(Strain, TargetID, BioRep, ExpRep)%>%
                    summarize(Median_Cq = median(Value.norm.mod0, na.rm=TRUE),
                              RNA_Abundance = (2^-Median_Cq), na.rm=FALSE)%>%
  
          # Below is to create columns for strain information using details from the 'Strain' column
                    separate(Strain, remove = FALSE,sep="-",into=c("Promoter","mCherry","Terminator")) %>%
                    separate(Terminator, remove = FALSE, sep="_",into=c("Terminator","Construct")) %>%
                    mutate(Construct = factor(Construct,levels = c("modE","modD","modC","modB","modA","mod0","WT")),remove = FALSE)%>%
                    unite(Pro_mCh,Promoter,mCherry,sep="-", remove=FALSE)%>%
                    unite(Ter_mod,Terminator,Construct,sep="_", remove=FALSE) %>%
                    mutate(Pro_mCh = factor(Pro_mCh,levels = c("pSRO9-mCherry","pPGK1-mCherry"))) %>% 
                    mutate(Ter_mod = factor(Ter_mod,levels=c("tRPS3_modC","tRPS3_modE","tRPS3_modD","tRPS3_modA",
                                           "tRPS3_modB","tRPS3_mod0","tRPS3_WT")))

# to verify the calculation done 
platesnorm_mod0_median_ExpRep %>% select(Strain, BioRep, Median_Cq, RNA_Abundance)
```

### 2B) Plotting the results in a scatter plot

```{r norm_plot1_ExpRep,fig.height=5,fig.width=5, echo=FALSE}

normalised_plot1_ExpRep <- ggplot(data = platesnorm_mod0_median_ExpRep %>% 
    filter(!Strain %in% c("pPGK1-mCherry-tRPS3_WT","pSRO9-mCherry-tRPS3_WT")))+
    geom_point(aes(RNA_Abundance,Ter_mod,colour=Ter_mod, shape=BioRep)) +
    scale_x_log2nice(name="Fold change in RNA abundance relative to tRPS3-mod0 \n (log2 scale)",omag = seq(-5,5),scilabels=FALSE) +
    labs(y="") +
    scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    scale_colour_manual(values=c("#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black")) +
    guides(colour=FALSE) +
    theme(axis.text.y=element_text(colour=c("#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black")),
          axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(size=10,vjust=-2),
          legend.position="bottom",
          legend.box.margin=margin(20,0,0,30))+
    facet_wrap(~Pro_mCh,nrow = 2)

normalised_plot1_ExpRep + stat_summary(aes(RNA_Abundance,Ter_mod),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 
```
