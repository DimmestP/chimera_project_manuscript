---
title: "RT-qPCR of pSRO9-mCh-tRPS3mod (2 reps)"
author: "Jamie Auxillos"
date: "21/09/2020"
output:
  html_document:
    toc: yes
    #toc_depth: 2
---

```{r setup,warning=FALSE,message=FALSE,echo=FALSE}

## knitr options for report generation
knitr::opts_chunk$set(warning=FALSE,message=FALSE,echo=TRUE,cache=FALSE,
                      #results="show",
                      fig.path="figures_tRPS3mod_dataanalysis/")

library(tidyverse)
library(cowplot)
library(tidyqpcr)

 # set default theme for graphics
theme_set(theme_cowplot(font_size=11) %+replace% 
              theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
                    panel.border=element_rect(colour = "grey50",linetype = "solid",size=0.5),
                    panel.grid.major = element_line(size = 0.25, linetype = 'solid',colour = "grey"),
                    plot.title = element_text(family="Tahoma",size=11,vjust=3.3),
                    strip.background = element_blank(),
                    strip.text.x=element_text(family="Tahoma",size=9),
                    axis.text=element_text(family="Tahoma", size=10),
                    axis.title=element_text(family="Tahoma", size=10),
                    legend.text=element_text(family="Tahoma", size=8),
                    legend.title=element_text(family="Tahoma", size=9)))
```

```{r label_plates,dependson="plate_functions", echo=FALSE}

# list Targets (Primer sets)
target_id <- c("mCh-7", "URA3-ORF", "RPS3-ORF", "PGK1-ORF")
target_id_values <-factor(rep(target_id,levels=target_id))


# labelling of sample_id attributes
strainlevelsS9 <- c("pSRO9-mCherry-tRPS3_WT","pSRO9-mCherry-tRPS3_mod0","pSRO9-mCherry-tRPS3_modA","pSRO9-mCherry-tRPS3_modB","pSRO9-mCherry-tRPS3_modC", "pSRO9-mCherry-tRPS3_modD", "pSRO9-mCherry-tRPS3_modE","POT1-ccdB")
strainvaluesS9 <- factor(rep(strainlevelsS9,each=3),levels=strainlevelsS9)
bio_replevels_A <- c("bio_rep1","bio_rep2","bio_rep3")
bio_repvalues_A <- factor(rep(bio_replevels_A,times=8),levels=bio_replevels_A)
bio_replevels_B <- c("bio_rep4","bio_rep5","bio_rep6")
bio_repvalues_B <- factor(rep(bio_replevels_B,times=8),levels=bio_replevels_B)

# Attribute labels to each row and column for each plate (pSRO9 and pPGK1 plates)
colkeyS9_1 <- tibble(well_col=1:24, strain=strainvaluesS9, bio_rep=bio_repvalues_A) 
colkeyS9_2 <- tibble(well_col=1:24, strain=strainvaluesS9, bio_rep=bio_repvalues_B) 
rowkey <- create_rowkey_4_in_16(target_id=target_id_values) 


# Combine all the information into 4x plate plans
plateplanS9_1 <-     
    label_plate_rowcol(create_blank_plate(well_row = LETTERS[1:16],well_col=1:24),
                       rowkey,colkeyS9_1%>% 
    unite(sample_id, strain,bio_rep,remove=FALSE)%>%
    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator")) %>%
    separate(terminator, remove = FALSE, sep="_",into=c("terminator","construct")) %>%
    mutate(construct = factor(construct,levels = c("modE","modD","modC","modB","modA","mod0","WT")),remove = FALSE)%>%
    unite(pro_mCh,promoter,mCherry,sep="-", remove=FALSE)%>%
    unite(ter_mod,terminator,construct,sep="_", remove=FALSE))

plateplanS9_2 <-     
    label_plate_rowcol(create_blank_plate(well_row = LETTERS[1:16],well_col=1:24),
                       rowkey,colkeyS9_2%>% 
    unite(sample_id,strain,bio_rep,remove=FALSE)%>%
    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator")) %>%
    separate(terminator, remove = FALSE, sep="_",into=c("terminator","construct")) %>%
    mutate(construct = factor(construct,levels = c("modE","modD","modC","modB","modA","mod0","WT")),remove = FALSE)%>%
    unite(pro_mCh,promoter,mCherry,sep="-", remove=FALSE)%>%
    unite(ter_mod,terminator,construct,sep="_", remove=FALSE))

```

## Load data and attribute sample information
```{r load_plates,dependson="label_plates",results="show"}
# read my plates
platesS9_1 <- read_tsv(here("./raw_data_analysis/data/raw_qpcr/JA_20200814-pSRO9-tRPS3mod-n1-ct.txt"),skip=1) %>%
    mutate(well=Pos,cq=Cp,exp_rep = "ExpRep1",exp_rep=factor(exp_rep)) %>%
    left_join(plateplanS9_1)


platesS9_2 <- read_tsv(here("./raw_data_analysis/data/raw_qpcr/JA_20200830-pSRO9-tRPS3mod-n2-ct.txt"),skip=1) %>%
    mutate(well=Pos,cq=Cp,exp_rep = "ExpRep2",exp_rep=factor(exp_rep)) %>%
    left_join(plateplanS9_2)

plates <- bind_rows(platesS9_1, platesS9_2)

summary(plates)
```


### Plotting unnormalised data for pSRO9 strains
```{r unnorm_pSRO9,dependson="load_plates",fig.height=5,fig.width=10, echo=FALSE}
platespSRO9 <- plates%>% filter(strain %in% c("pSRO9-mCherry-tRPS3_WT","pSRO9-mCherry-tRPS3_mod0","pSRO9-mCherry-tRPS3_modA","pSRO9-mCherry-tRPS3_modB",
                                           "pSRO9-mCherry-tRPS3_modC","pSRO9-mCherry-tRPS3_modD","pSRO9-mCherry-tRPS3_modE"))%>%
  mutate(strain = factor(strain,levels=c("pSRO9-mCherry-tRPS3_WT","pSRO9-mCherry-tRPS3_mod0","pSRO9-mCherry-tRPS3_modA","pSRO9-mCherry-tRPS3_modB",
                                           "pSRO9-mCherry-tRPS3_modC","pSRO9-mCherry-tRPS3_modD","pSRO9-mCherry-tRPS3_modE")))

ggplot(data=platespSRO9, aes(x=target_id,y=cq)) +
    geom_point(aes(color=bio_rep, shape=prep_type),
               position=position_dodge(width = 0.85),size=1.6, alpha=0.7) +
    labs(y="Quantification cycle (cq)",x="Primers") +
    scale_shape_manual(values=c(16,23)) +
    scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
    facet_wrap(~strain,ncol=4) +
    theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3),
          legend.position=c(0.85,0.01))
```


### Plotting unnormalised data for control strains (pSRO9-mCherry-tRPS3_WT and POT1-ccdB)

```{r unnorm_POT_pSRO9, fig.height=3.5,fig.width=5.5, echo=FALSE}

platesPOT_RPS3 <- plates%>% filter(strain %in% c("pSRO9-mCherry-tRPS3_WT","POT1-ccdB"))

ggplot(data=platesPOT_RPS3, aes(x=target_id,y=cq)) +
  geom_point(aes(color=bio_rep, shape=prep_type),
               position=position_dodge(width = 0.85),size=1.5, alpha=0.7) +
  labs(title="Controls for pSRO9 strains - \n Comparing between experimental replicates",y="Quantification cycle (cq)",x="Primers") +
  ylim(0,40)+
  scale_shape_manual(values=c(16,23)) +
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  facet_wrap(~strain,ncol=2)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5),
          axis.title.x=element_text(vjust=-2),
          axis.title.y=element_text(vjust=3))
```


## Loading amplification and melt curve pSRO9 data

```{r load_amp-melt_S9,dependson="label_plates", results="show"}

platecurveS9_1 <- read_tsv(here("./raw_data_analysis/data/raw_qpcr/JA_20200814-pSRO9-tRPS3mod-n1.txt"),skip=2,
                           col_names=c("well","SID","program_no","segment","cycle","time","temperature","fluor_raw")) %>%
    debaseline() %>%left_join(plateplanS9_1)%>%
    mutate(exp_rep = "ExpRep1",exp_rep=factor(exp_rep))

platecurveS9_2 <- read_tsv(here("./raw_data_analysis/data/raw_qpcr/JA_20200830-pSRO9-tRPS3mod-n2.txt"),skip=2,
                           col_names=c("well","SID","program_no","segment","cycle","time","temperature","fluor_raw")) %>%
    debaseline() %>%left_join(plateplanS9_2)%>%
    mutate(exp_rep = "ExpRep2",exp_rep=factor(exp_rep))

platecurveS9 <- bind_rows(platecurveS9_1, platecurveS9_2)

platesampS9  <- platecurveS9 %>% filter(program_no == 2)
platesmeltS9 <- platecurveS9 %>% filter(program_no != 2) %>% getdRdTall() %>% filter(temperature >= 61)  
head(platesampS9)
head(platesmeltS9)
```

### Amplification Curves of POT1-ccdB strains (all bioreps) against all 4 target_ids (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pSRO9)

```{r plotamp_Rep1_S9,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesampS9 %>% filter(strain==c("POT1-ccdB")),
       aes(x=cycle,y=fluor_signal,linetype=prep_type,group=well, color=exp_rep)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of POT1-ccdB strains (bio_rep 1-6) in pSRO9 experiments") + panel_border()

ggplot(data=platesampS9 %>% filter(strain==c("pSRO9-mCherry-tRPS3_WT")),
       aes(x=cycle,y=fluor_signal,linetype=prep_type,group=well, color=exp_rep)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line() +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    expand_limits(y=0) + 
    labs(title="Amplification curves of pSRO9-mCherry-tRPS3_WT strains (bio_rep 1-6) in pSRO9 experiments") + panel_border()
```


### Melt Curves of POT1-ccdB and pSRO9-mCherry-tRPS3_WT strains (all bioreps) against all 4 target_ids (mCh-7, PGK1-ORF, RPS3-ORF, URA3-ORF) (pSRO9)

```{r plotmelt_Rep1_S9,dependson="load_amp",fig.width=8,fig.height=6, echo=FALSE}
ggplot(data=platesmeltS9 %>% filter(strain==c("POT1-ccdB")),
       aes(x=temperature,y=dRdT,group=well)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line(aes(color=exp_rep, linetype=prep_type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of POT1-ccdB strains (bio_rep 1-6) in pSRO9 experiments") + panel_border()

ggplot(data=platesmeltS9 %>% filter(strain==c("pSRO9-mCherry-tRPS3_WT")),
       aes(x=temperature,y=dRdT,group=well)) + 
    facet_grid(bio_rep~target_id) + 
    geom_line(aes(color=exp_rep, linetype=prep_type)) +
    scale_linetype_manual(values=c("-RT"="dashed","+RT"="solid")) +
    scale_x_continuous(breaks=seq(60,100,10),minor_breaks=seq(60,100,5)) + 
    labs(title="Melt curves of pSRO9-mCherry-tRPS3_WT strains (bio_rep 1-6) in pSRO9 experiments") + panel_border()
```


## 1) Delta cq calculation
Normalisation of mCherry cq values against PGK1-ORF, URA3-ORF and RPS3-ORF cq values. This calculation takes the **median** of normtarget_ids (getNormcq function default is **median**)

```{r deltacq_norm,dependson="load_plates", echo=TRUE, fig.height=6, fig.width=9}


# platesnorm first excludes pPGK1-mCherry-tRPS3_WT_bio_rep2, and all POT1-ccdB strains, then takes all +RT results, then normalises the cq values by the median of normtarget_ids, then filters cq values for mCh-7
platesnorm <- plates  %>% 
        filter(!strain %in% c("POT1-ccdB"), prep_type=="+RT") %>%    
        calculate_deltacq_bysampleid(ref_target_ids = c("PGK1-ORF","RPS3-ORF","URA3-ORF"), norm_function = mean) 

# to verify the calculation done 
platesnorm %>% select(strain, bio_rep, tech_rep, delta_cq, rel_abund)

ggplot(platesnorm, aes(ter_mod,delta_cq))+
  geom_point(aes(color=bio_rep),position=position_dodge(width = 0.85),size=1.2, alpha=0.7)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  labs(y="delta cq", x="3'UTR-terminators")+
  facet_wrap(~target_id)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 

ggplot(platesnorm %>% filter(promoter %in% c("pSRO9")), aes(ter_mod,delta_cq))+
  geom_point(aes(color=bio_rep),position=position_dodge(width = 0.8),size=1.5, alpha=0.7)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  ylim(-6,6)+
  labs(y="delta cq", x="3'UTR-terminators")+
  facet_wrap(~target_id)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 

```

Plot shows shifted distributions in normalised cq values for pSRO9 samples between experimental replciates. This shift in distributions between experimental replicates is not seen for pPGK1 samples.
```{r deltacq_norm_1,dependson="load_plates", echo=TRUE, fig.height=5, fig.width=9}

ggplot(platesnorm %>% filter(target_id %in% 'mCh-7'), aes(ter_mod,delta_cq))+
  geom_point(aes(color=bio_rep),position=position_dodge(width = 0.85),size=1.2, alpha=1)+
  scale_colour_hue(h = c(90, 360)+20,l=60,c=60)+
  labs(y="delta cq", x="3'UTR-terminators")+
  facet_wrap(~promoter)+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  geom_hline(yintercept = 0, color = "black", linetype= 'dotted', size=1) 
```

## 2A) Delta-delta cq and RNA abundance calculation (one mod0 mean per exp_rep per promoter)
Normalisation of delta cq values against tRPS3-mod0 delta cq values. strains are first subdivided based on their promoter (either pPGK1 or pSRO9).   

pSRO9-mCherry-tRPS3_mod0 datapoints were divided into two based on exp_rep. From this, two (depending on exp_rep) **Mean delta_cq of pSRO9-mCherry-tRPS3_mod0** were calculated by taking the median delta_cq among tech_reps of each bio_rep (of pSRO9-mCherry-tRPS3_mod0), then calculating **two** mean delta_cq among bio_reps of pSRO9-mCherry-tRPS3_mod0 for each exp_rep. 

pSRO9 datapoints were subdivided based on exp_rep. Delta delta cq is calculated by subtracting the **Mean delta_cq of pSRO9-mCherry-tRPS3_mod0 of exp_rep1** from each delta_cq of all other strains in exp_rep1. Delta delta cq is calculated by subtracting the **Mean delta_cq of pSRO9-mCherry-tRPS3_mod0 of exp_rep2** from each delta_cq of all other strains in exp_rep2. (NOTE - we still have one delta_cq for each tech_rep and bio_rep here). 

**NOTE - Here median is used to summarise/collapse tech_reps and mean is used to summarise/collapse bio_reps**
```{r delta-deltacq_norm_RPS3_exp_rep, echo=TRUE}

# Extracts the pSRO9 strains
platesnorm_pSRO9_exp_rep <- platesnorm %>% filter(promoter %in% "pSRO9", target_id %in% "mCh-7")

#write_csv(platesnorm_pSRO9_exp_rep, here("raw_data_analysis/data/norm_qpcr/pSRO9_tRPS3_n1_n2_norm_mean.csv"))
  
  
# Calculates the mean cq value of pSRO9-mCherry-tRPS3_mod0 Samples (-0.3833333	)
mean_platesnorm_pSRO9mod0_exp_rep1 <- platesnorm_pSRO9_exp_rep  %>% filter(exp_rep== "ExpRep1")%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pSRO9-mCherry-tRPS3_mod0")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_pSRO9mod0 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_pSRO9mod0 = mean(median_bio_rep_pSRO9mod0))

# Calculates the mean cq value of pSRO9-mCherry-tRPS3_mod0 Samples (-1.346667	)
mean_platesnorm_pSRO9mod0_exp_rep2 <- platesnorm_pSRO9_exp_rep  %>% filter(exp_rep== "ExpRep2")%>%
    select(c("strain","delta_cq", "bio_rep", "tech_rep")) %>% 
    filter(strain %in% c("pSRO9-mCherry-tRPS3_mod0")) %>%
    group_by(strain, bio_rep)%>%
    summarize(median_bio_rep_pSRO9mod0 = median(delta_cq)) %>%
    ungroup()%>%
    group_by(strain)%>%
    summarize(mean_pSRO9mod0 = mean(median_bio_rep_pSRO9mod0))

# Calculates the delta delta cq (subtracts mean(pSRO9mod0$delta_cq) from every delta_cq))
platesnorm_mod0_pSRO9_exp_rep1 <- platesnorm_pSRO9_exp_rep %>% filter(exp_rep== "ExpRep1")%>%
    mutate(delta_cq.mod0 = delta_cq - mean_platesnorm_pSRO9mod0_exp_rep1$mean_pSRO9mod0, remove=FALSE)
platesnorm_mod0_pSRO9_exp_rep2 <- platesnorm_pSRO9_exp_rep %>% filter(exp_rep== "ExpRep2")%>%
    mutate(delta_cq.mod0 = delta_cq - mean_platesnorm_pSRO9mod0_exp_rep2$mean_pSRO9mod0, remove=FALSE)

# to verify the calculation done 
platesnorm_mod0_pSRO9_exp_rep1 %>% select(strain, bio_rep, tech_rep, delta_cq.mod0)
```

## 2B) Mean cq and RNA abundance calculation
In the previous 2 chunks, we have calculated the delta-delta cq value for each techrep. Here, we are summarising that information by calculating the median cq for each biorep and calculating the RNA abundance (2^-Median_cq).  

```{r mean_rna_abund_exp_rep, echo=TRUE}

# Combining the calculated delta-delta cq from the two dataframes then calculating the Median delta-delta cq. RNA abundance is calculated by the following formula 2^(- Median_cq). 
platesnorm_mod0_median_exp_rep <- bind_rows(platesnorm_mod0_pSRO9_exp_rep1, platesnorm_mod0_pSRO9_exp_rep2)%>%
                    group_by(strain, target_id, bio_rep, exp_rep)%>%
                    summarize(Median_cq = median(delta_cq.mod0, na.rm=TRUE),
                              RNA_Abundance = (2^-Median_cq), na.rm=FALSE)%>%
  
          # Below is to create columns for strain information using details from the 'strain' column
                    separate(strain, remove = FALSE,sep="-",into=c("promoter","mCherry","terminator")) %>%
                    separate(terminator, remove = FALSE, sep="_",into=c("terminator","construct")) %>%
                    mutate(construct = factor(construct,levels = c("modE","modD","modC","modB","modA","mod0","WT")),remove = FALSE)%>%
                    unite(pro_mCh,promoter,mCherry,sep="-", remove=FALSE)%>%
                    unite(ter_mod,terminator,construct,sep="_", remove=FALSE) %>%
                    mutate(pro_mCh = factor(pro_mCh,levels = c("pSRO9-mCherry","pPGK1-mCherry"))) %>% 
                    mutate(ter_mod = factor(ter_mod,levels=c("tRPS3_modC","tRPS3_modE","tRPS3_modD","tRPS3_modA",
                                           "tRPS3_modB","tRPS3_mod0","tRPS3_WT")))

# to verify the calculation done 
platesnorm_mod0_median_exp_rep %>% select(strain, bio_rep, Median_cq, RNA_Abundance)
```

### 2B) Plotting the results in a scatter plot

```{r norm_plot1_exp_rep,fig.height=5,fig.width=5, echo=FALSE}

normalised_plot1_exp_rep <- ggplot(data = platesnorm_mod0_median_exp_rep %>% 
    filter(!strain %in% c("pPGK1-mCherry-tRPS3_WT","pSRO9-mCherry-tRPS3_WT")))+
    geom_point(aes(RNA_Abundance,ter_mod,colour=ter_mod, shape=bio_rep)) +
    scale_x_log2nice(name="Fold change in RNA abundance relative to tRPS3-mod0 \n (log2 scale)",omag = seq(-5,5),scilabels=FALSE) +
    labs(y="") +
    scale_shape_manual(values=c(19, 17, 15, 10, 7, 14)) +
    scale_colour_manual(values=c("#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black")) +
    guides(colour=FALSE) +
    theme(axis.text.y=element_text(colour=c("#288a2e","#a84a9a","#6f3ba1","#416db0","#CC6666","black")),
          axis.text.x=element_text(angle=0,vjust=0.5),
          axis.title.x=element_text(size=10,vjust=-2),
          legend.position="bottom",
          legend.box.margin=margin(20,0,0,30))+
    facet_wrap(~pro_mCh,nrow = 2)

normalised_plot1_exp_rep + stat_summary(aes(RNA_Abundance,ter_mod),
    fun="mean",colour="black",
    geom="crossbar",size=0.2, width=0.5) 
```
